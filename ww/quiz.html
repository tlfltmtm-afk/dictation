<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœï¸ ê±°ê¾¸ë¡œ ë°›ì•„ì“°ê¸°</title>
    <style>
        /* (ê¸°ë³¸ ìŠ¤íƒ€ì¼ ...) */
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap');

        :root {
            --font-main: 'Gowun Dodum', sans-serif;
            --color-bg: #f7f3e9;
            --color-surface: #fff;
            --color-primary: #5cb85c;
            /* green */
            --color-secondary: #0275d8;
            /* blue */
            --color-warning: #f0ad4e;
            /* orange */
            --color-info: #5bc0de;
            /* cyan */
            --color-danger: #d9534f;
            /* red */
            --color-text: #333;
            --color-text-light: #888;
            --color-disabled: #ccc;
            --color-hint-active: #6c757d;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
        }

        main {
            background-color: var(--color-surface);
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            padding: 30px 40px;
            box-sizing: border-box;
            text-align: center;
            position: relative;
            transition: filter 0.3s ease-in-out;
        }

        main.grayscale {
            filter: grayscale(100%);
        }

        #info-link {
            position: absolute;
            top: 30px;
            right: 40px;
            opacity: 0.8;
            transition: opacity 0.2s;
            font-size: 28px;
            /* ì´ëª¨ì§€ í¬ê¸° */
            text-decoration: none;
            color: var(--color-warning);
            /* ì´ëª¨ì§€ ìƒ‰ìƒ (ì¼ë¶€ í™˜ê²½) */
        }

        #info-link:hover {
            opacity: 1;
        }


        h1 {
            color: var(--color-primary);
            margin-top: 0;
            margin-bottom: 10px;
        }

        #q-nav-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        #progress-indicator {
            font-size: 1.1em;
            color: var(--color-text-light);
            font-weight: bold;
            margin: 0;
        }

        .q-nav-btn {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--color-secondary);
            cursor: pointer;
            text-decoration: none;
            padding: 0 10px;
            user-select: none;
        }

        .q-nav-btn:hover {
            color: var(--color-primary);
        }

        .q-nav-btn.disabled {
            color: var(--color-disabled);
            cursor: not-allowed;
            opacity: 0.5;
        }


        #audio-controls-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 25px;
        }

        .audio-btn {
            padding: 12px 5px;
            font-size: 1.0em;
            font-family: var(--font-main);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            transition: background-color 0.2s, opacity 0.2s;
        }

        #play-1,
        #play-3,
        #play-5 {
            background-color: var(--color-secondary);
        }

        #play-1:hover:not(:disabled),
        #play-3:hover:not(:disabled),
        #play-5:hover:not(:disabled) {
            background-color: #025aa5;
        }

        #play-slow {
            background-color: var(--color-info);
        }

        #play-slow:hover:not(:disabled) {
            background-color: #4694ab;
        }

        #play-all {
            background-color: var(--color-danger);
        }

        #play-all:hover:not(:disabled) {
            background-color: #b0413e;
        }


        #problem-list-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            min-height: 40px;
            align-items: center;
        }

        .problem-list-item {
            padding: 6px 12px;
            font-size: 1.0em;
            font-family: var(--font-main);
            border-radius: 6px;
            background-color: #e0e0e0;
            border: 1px solid #c0c0c0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .problem-list-item.blurred {
            filter: blur(3px);
            color: transparent;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            user-select: none;
        }

        .problem-list-item.completed {
            filter: none;
            background-color: var(--color-surface);
            color: var(--color-text);
            border-color: #ccc;
            text-shadow: none;
        }

        .problem-list-item.current {
            background-color: var(--color-warning);
            border-color: var(--color-warning);
            font-weight: bold;
            transform: scale(1.05);
            text-shadow: 0 0 6px rgba(255, 255, 255, 0.7);
        }

        #answer-input {
            width: 100%;
            padding: 15px;
            font-size: 1.3em;
            font-family: var(--font-main);
            border: 2px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            text-align: center;
            margin-bottom: 15px;
        }

        #submission-area {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .submit-area-btn {
            padding: 15px;
            font-size: 1.3em;
            font-weight: bold;
            font-family: var(--font-main);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            transition: background-color 0.2s, opacity 0.2s;
            flex: 1;
        }

        #submit-btn {
            background-color: var(--color-primary);
            flex: 2;
        }

        .q-nav-btn-bottom {
            background-color: #888;
            font-size: 1.5em;
            padding: 10px;
            line-height: 1.3;
        }

        .q-nav-btn-bottom:hover:not(:disabled) {
            background-color: #666;
        }


        #feedback-area {
            min-height: 24px;
            padding: 5px 0;
            margin-top: 10px;
            font-size: 1.2em;
            font-weight: bold;
            line-height: 1.6;
            text-align: center;
        }

        #feedback-area.correct {
            color: var(--color-primary);
        }

        #feedback-area.incorrect {
            color: var(--color-danger);
        }

        hr.divider {
            border: 0;
            height: 1px;
            background-color: #eee;
            margin-top: 10px;
            margin-bottom: 15px;
        }

        #hint-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .hint-btn {
            padding: 12px 10px;
            font-size: 1.1em;
            font-family: var(--font-main);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--color-warning);
            color: white;
            transition: background-color 0.2s, opacity 0.2s;
        }

        .hint-btn:hover:not(:disabled) {
            background-color: #e89e3a;
        }

        .hint-btn.active {
            background-color: var(--color-hint-active);
        }

        .hint-btn.active:hover:not(:disabled) {
            background-color: #5a6268;
        }

        /* --- íŒíŠ¸ í‘œì‹œ ì˜ì—­ --- */
        #result-area {
            min-height: 50px;
            padding: 0;
            margin-bottom: 25px;
            font-size: 1.1em;
            line-height: 1.6;
            text-align: left;
        }

        .hint-display {
            display: none;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #ddd;
        }

        .hint-display.two-column {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px;
            align-items: center;
            padding: 10px 15px;
        }

        .hint-label-box {
            background-color: #f4f4f4;
            padding: 15px 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
        }

        .hint-content-box {
            text-align: center;
            font-size: 1.15em;
            font-weight: 500;
            word-break: keep-all;
        }

        .diff-char-red {
            color: var(--color-danger);
            font-weight: bold;
        }

        .diff-char-black {
            color: var(--color-text);
        }


        #hint-display-answer {
            background-color: #fdfaf2;
            border-color: var(--color-warning);
            border-width: 2px;
        }

        #hint-display-answer .hint-label-box {
            background-color: #fff;
            border: 1px solid #f0ad4e;
        }

        #hint-display-sound {
            background-color: #f7faff;
            border-color: var(--color-secondary);
            border-width: 2px;
        }

        #hint-display-sound .hint-label-box {
            background-color: #fff;
            border: 1px solid #0275d8;
        }


        #hint-display-rule {
            background-color: #f9f9f9;
            border-color: #eee;
        }

        .rule-link-icon {
            display: inline-block;
            text-decoration: none;
            margin-left: 5px;
            vertical-align: middle;
            opacity: 0.8;
            transition: opacity 0.2s;
            color: var(--color-secondary);
            font-size: 1.1em;
            /* ì´ëª¨ì§€ í¬ê¸° */
        }

        .rule-link-icon:hover {
            opacity: 1;
            color: var(--color-primary);
        }

        #rule-hint-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
        }

        .rule-hint-btn {
            padding: 8px 12px;
            font-size: 1.0em;
            font-family: var(--font-main);
            border: 1px solid var(--color-warning);
            border-radius: 8px;
            cursor: pointer;
            background-color: #fff;
            color: var(--color-text);
            flex-grow: 1;
            flex-basis: 0;
            min-width: 60px;
            transition: background-color 0.2s, color 0.2s;
        }

        .rule-hint-btn.show-all {
            background-color: var(--color-info);
            color: white;
            border-color: var(--color-info);
            font-weight: bold;
        }

        .rule-hint-btn.active {
            background-color: var(--color-hint-active);
            color: white;
            border-color: #5a6268;
        }

        /* --- (íŒíŠ¸ ë) --- */

        #navigation-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #next-btn {
            padding: 12px 25px;
            font-size: 1.2em;
            font-family: var(--font-main);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: #333;
            color: white;
            transition: background-color 0.2s;
        }

        #next-btn:hover {
            background-color: #555;
        }

        #back-link {
            font-size: 1.1em;
            color: var(--color-secondary);
            text-decoration: none;
        }

        #back-link:hover {
            text-decoration: underline;
        }

        [disabled] {
            background-color: var(--color-disabled) !important;
            opacity: 0.7;
            cursor: not-allowed !important;
        }

        /* --- ëª¨ë‹¬ ê³µí†µ ìŠ¤íƒ€ì¼ --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            border-radius: 15px;
            padding: 30px 40px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
        }

        .modal-text {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--color-text);
            margin-bottom: 30px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            font-size: 1.2em;
            font-family: var(--font-main);
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        /* --- 1. ì •ë‹µ íŒì—… ëª¨ë‹¬ --- */
        #modal-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 25px auto;
            border: 15px solid var(--color-danger);
            /* ë¹¨ê°„ìƒ‰ í…Œë‘ë¦¬ */
            background-color: transparent;
            /* ê°€ìš´ë° ë¹„ìš°ê¸° */
            box-sizing: border-box;
            /* í¬ê¸° ìœ ì§€ */
        }

        #modal-close-btn {
            background-color: #aaa;
            color: white;
        }

        #modal-close-btn:hover {
            background-color: #888;
        }

        #modal-next-btn {
            background-color: var(--color-primary);
            color: white;
        }

        #modal-next-btn:hover {
            background-color: #4a9e4a;
        }

        /* --- [ìš”ì²­ ì‚¬í•­] 2. í€´ì¦ˆ ì™„ë£Œ íŒì—… ëª¨ë‹¬ --- */
        #quiz-complete-modal-text {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--color-text);
            margin-bottom: 30px;
        }

        #quiz-complete-close-btn {
            background-color: #aaa;
            color: white;
        }

        #quiz-complete-close-btn:hover {
            background-color: #888;
        }

        #quiz-complete-home-btn {
            background-color: var(--color-primary);
            color: white;
        }

        #quiz-complete-home-btn:hover {
            background-color: #4a9e4a;
        }

        /* --- (ëª¨ë‹¬ ë) --- */

        /* ë¹„í™œì„±í™”ëœ ì œì¶œ ë²„íŠ¼ì˜ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
        #submit-btn:disabled {
            color: white;
        }
    </style>
</head>

<body>
    <main id="main-content">
        <a href="rules.html" id="info-link" target="_blank" title="ê·œì¹™ ì„¤ëª… ë³´ê¸°">ğŸ“š</a>

        <h1>âœï¸ ê±°ê¾¸ë¡œ ë°›ì•„ì“°ê¸°</h1>

        <div id="audio-controls-container">
            <button id="play-slow" class="audio-btn">ğŸ”Š ëŠë¦¬ê²Œ</button>
            <button id="play-1" class="audio-btn">ğŸ”Š 1íšŒ</button>
            <button id="play-3" class="audio-btn">ğŸ”Š 3íšŒ</button>
            <button id="play-5" class="audio-btn">ğŸ”Š 5íšŒ</button>
            <button id="play-all" class="audio-btn">ğŸ”Š ì „ì²´</button>
        </div>

        <div id="problem-list-container">
        </div>

        <div id="q-nav-container">
            <a id="prev-q-btn" class="q-nav-btn" title="ì´ì „ ë¬¸ì œ">â—€</a>
            <div id="progress-indicator">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            <a id="next-q-btn" class="q-nav-btn" title="ë‹¤ìŒ ë¬¸ì œ">â–¶</a>
        </div>

        <input type="text" id="answer-input" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”">

        <div id="submission-area">
            <button id="prev-q-btn-bottom" class="submit-area-btn q-nav-btn-bottom" title="ì´ì „ ë¬¸ì œ">â—€</button>
            <button id="submit-btn" class="submit-area-btn">ì œì¶œí•˜ê¸°</button>
            <button id="next-q-btn-bottom" class="submit-area-btn q-nav-btn-bottom" title="ë‹¤ìŒ ë¬¸ì œ (ê±´ë„ˆë›°ê¸°)">â–¶</button>
        </div>

        <div id="feedback-area"></div>

        <hr class="divider">

        <div id="hint-container">
            <button id="hint-sound" class="hint-btn">ğŸ’¡ ì†Œë¦¬ íŒíŠ¸</button>
            <button id="hint-rule" class="hint-btn">ğŸ§© ê·œì¹™ íŒíŠ¸</button>
            <button id="hint-answer" class="hint-btn">ğŸ‘€ ì •ë‹µ ë³´ê¸°</button>
        </div>

        <div id="result-area">
            <div id="hint-display-answer" class="hint-display two-column"></div>
            <div id="hint-display-sound" class="hint-display two-column"></div>
            <div id="hint-display-rule" class="hint-display"></div>
        </div>

        <div id="navigation-area">
            <a href="index.html" id="back-link">â† ë²”ìœ„ ì„ íƒìœ¼ë¡œ</a>
            <button id="next-btn" style="display: none;">ë‹¤ìŒ ë¬¸ì œ â”</button>
        </div>
    </main>

    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content">
            <div id="modal-circle"></div>
            <div id="modal-text" class="modal-text">ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤!</div>
            <div id="modal-buttons" class="modal-buttons">
                <button id="modal-close-btn" class="modal-btn">ë‹«ê¸°</button>
                <button id="modal-next-btn" class="modal-btn">ë‹¤ìŒ ë¬¸ì œ â”</button>
            </div>
        </div>
    </div>

    <div id="quiz-complete-modal-overlay" class="modal-overlay">
        <div id="quiz-complete-modal-content" class="modal-content">
            <div id="quiz-complete-modal-text" class="modal-text">âœ¨ ëª¨ë“  í€´ì¦ˆë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!</div>
            <p style="font-size: 1.1em; margin-top: -15px; margin-bottom: 30px;">ì¶•í•˜í•©ë‹ˆë‹¤! <br>ë²”ìœ„ ì„ íƒ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€<br>ë‹¤ë¥¸ í€´ì¦ˆì—
                ë„ì „í•´ë³´ì„¸ìš”.</p>
            <div id="quiz-complete-modal-buttons" class="modal-buttons">
                <button id="quiz-complete-close-btn" class="modal-btn">ë‹«ê¸°</button>
                <button id="quiz-complete-home-btn" class="modal-btn">í™ˆ(ì¸ë±ìŠ¤)ìœ¼ë¡œ</button>
            </div>
        </div>
    </div>


    <script src="database.js"></script>

    <script>
        // --- 1. ì „ì—­ ë³€ìˆ˜ ë° DOM ìš”ì†Œ ---
        let quizSet = [];
        let currentQuestionIndex = 0;
        let currentQuestion = null;
        let currentAudio = null;
        let audioPlayLoopId = null;

        let allAudioPlayer = {
            index: 0,
            timeoutId: null,
            audio: null,
            isPlaying: false
        };

        let keyForAudio, keyForAnswer, keyForSoundHint, keyForRules, keyForHints;
        let placeholderText;

        let isSoundHintVisible = false;
        let isRuleHintVisible = false;
        let isAnswerHintVisible = false;

        let ruleHintData = {};
        let isAllRulesVisible = false;

        const ruleFileMap = {
            1: 'rule01_yeonum.html',
            2: 'rule02_eumjeol_kkwessori.html',
            3: 'rule03_jaeumgun_dansunhwa.html',
            4: 'rule04_doensori_doegi.html',
            5: 'rule05_jaeum_donghwa.html',
            6: 'rule06_gugaeumhwa.html',
            7: 'rule07_jaeum_chukyak.html',
            8: 'rule08_h_tallak.html',
            9: 'rule09_moeum_chukyak.html',
            10: 'rule10_n_cheomga.html',
            11: 'rule11_dueum_beopchik.html',
            12: 'rule12_ttyeossuegi.html',
            13: 'rule13_ssangdungyi_moeum.html',
            14: 'rule14_sori_pyogi.html'
        };

        // DOM ìš”ì†Œ ìºì‹±
        const mainContent = document.getElementById('main-content');

        // ì •ë‹µ ëª¨ë‹¬
        const modalOverlay = document.getElementById('modal-overlay');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalNextBtn = document.getElementById('modal-next-btn');

        // [ìš”ì²­ ì‚¬í•­] í€´ì¦ˆ ì™„ë£Œ ëª¨ë‹¬
        const quizCompleteModalOverlay = document.getElementById('quiz-complete-modal-overlay');
        const quizCompleteCloseBtn = document.getElementById('quiz-complete-close-btn');
        const quizCompleteHomeBtn = document.getElementById('quiz-complete-home-btn');


        const problemListContainer = document.getElementById('problem-list-container');
        const progressIndicator = document.getElementById('progress-indicator');
        const prevQBtn = document.getElementById('prev-q-btn');
        const nextQBtn = document.getElementById('next-q-btn');
        const answerInput = document.getElementById('answer-input');
        const submitBtn = document.getElementById('submit-btn');

        const prevQBtnBottom = document.getElementById('prev-q-btn-bottom');
        const nextQBtnBottom = document.getElementById('next-q-btn-bottom');

        const feedbackArea = document.getElementById('feedback-area');
        const resultArea = document.getElementById('result-area');
        const nextBtn = document.getElementById('next-btn');
        const backLink = document.getElementById('back-link');

        const hintDisplayAnswer = document.getElementById('hint-display-answer');
        const hintDisplaySound = document.getElementById('hint-display-sound');
        const hintDisplayRule = document.getElementById('hint-display-rule');

        const hintContainer = document.getElementById('hint-container');

        const playSlowBtn = document.getElementById('play-slow');
        const play1Btn = document.getElementById('play-1');
        const play3Btn = document.getElementById('play-3');
        const play5Btn = document.getElementById('play-5');
        const playAllBtn = document.getElementById('play-all');

        const hintSoundBtn = document.getElementById('hint-sound');
        const hintRuleBtn = document.getElementById('hint-rule');
        const hintAnswerBtn = document.getElementById('hint-answer');

        const allAudioButtons = [play1Btn, play3Btn, play5Btn, playSlowBtn, playAllBtn];
        const allHintButtons = [hintSoundBtn, hintRuleBtn, hintAnswerBtn];

        const bookIconEmoji = 'ğŸ“š';

        // --- í…ìŠ¤íŠ¸ ì •ê·œí™” ---
        function normalizeText(text) {
            if (typeof text !== 'string') return "";
            return text.replace(/[.,!?~"'"\[\]]/g, '');
        }

        // --- 2. í˜ì´ì§€ ì´ˆê¸°í™” ---
        window.onload = () => {
            try {
                if (typeof quizData === 'undefined') {
                    throw new Error("database.jsë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆê±°ë‚˜ quizData ë³€ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }

                const params = new URLSearchParams(window.location.search);
                const grade = params.get('grade');
                const unit = params.get('unit');
                const rule = params.get('rule');
                const quizType = params.get('type') || 'word';

                setupQuizType(quizType);
                filterQuizSet(grade, unit, rule, quizType);

                if (quizSet.length > 0) {
                    generateProblemList();
                    loadQuestion(0);
                } else {
                    handleNoQuestions();
                }

                setupEventListeners();

            } catch (error) {
                console.error("í€´ì¦ˆ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                main.innerHTML = `<h1>ì˜¤ë¥˜ ë°œìƒ</h1><p>í€´ì¦ˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
            }
        };

        // --- 3. ì´ˆê¸°í™” í—¬í¼ í•¨ìˆ˜ ---
        function setupQuizType(quizType) {
            if (quizType === 'sentence') {
                keyForAudio = "Audio File Name (Sentence)";
                keyForAnswer = "Sentence Notation";
                keyForSoundHint = "Sentence sound notation";
                keyForRules = ["Syllable 1 Rule", "Syllable 2 rule", "Syllable 3 Rule", "Syllable 4 Rule", "Syllable 5 Rule"];
                keyForHints = ["Syllable 1 Rule", "Syllable 2 rule", "Syllable 3 Rule", "Syllable 4 Rule", "Syllable 5 Rule"];
                placeholderText = "ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”.(ë„ì–´ì“°ê¸° í¬í•¨)";
            } else {
                keyForAudio = "Audio File Name (Word)";
                keyForAnswer = "Word Notation";
                keyForSoundHint = "Word phonetic notation";
                keyForRules = ["Syllable 1 Rule", "Syllable 2 rule", "Syllable 3 Rule", "Syllable 4 Rule", "Syllable 5 Rule"];
                keyForHints = ["Syllable 1 Rule", "Syllable 2 rule", "Syllable 3 Rule", "Syllable 4 Rule", "Syllable 5 Rule"];
                placeholderText = "ë‚±ë§ì„ ì…ë ¥í•˜ì„¸ìš”";
            }
            answerInput.placeholder = placeholderText;
        }

        function filterQuizSet(grade, unit, rule, quizType) {
            quizSet = quizData.filter(item => {
                const gradeMatch = (grade === 'all' || item["Year/Semester"] === grade);
                const unitMatch = (unit === 'all' || item["Chapter"] === unit);

                let ruleMatch = (rule === 'all');
                if (rule !== 'all') {
                    for (const ruleKey of keyForRules) {
                        if (item[ruleKey] === rule) {
                            ruleMatch = true;
                            break;
                        }
                    }
                }

                const typeMatch = (quizType === 'word' || (item[keyForAnswer] && item[keyForAnswer].trim() !== ""));

                return gradeMatch && unitMatch && ruleMatch && typeMatch;
            });

            // ì…”í”Œ
            for (let i = quizSet.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [quizSet[i], quizSet[j]] = [quizSet[j], quizSet[i]];
            }

            // ê° ë¬¸ì œì— 'isCompleted' ìƒíƒœ ì¶”ê°€
            quizSet.forEach(item => item.isCompleted = false);
        }

        function generateProblemList() {
            problemListContainer.innerHTML = '';
            quizSet.forEach((item, index) => {
                const div = document.createElement('div');
                div.id = `problem-item-${index}`;
                div.className = 'problem-list-item blurred';
                div.textContent = item[keyForAnswer];
                div.onclick = () => {
                    if (index !== currentQuestionIndex) {
                        loadQuestion(index);
                    }
                };
                problemListContainer.appendChild(div);
            });
        }


        // --- 4. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
        function setupEventListeners() {
            play1Btn.onclick = () => playAudio(1, 0, 1.0);
            play3Btn.onclick = () => playAudio(3, 1000, 1.0);
            play5Btn.onclick = () => playAudio(5, 1000, 1.0);
            playSlowBtn.onclick = () => playAudio(1, 0, 0.75);
            playAllBtn.onclick = playAllAudio;

            prevQBtn.onclick = loadPreviousQuestion;
            nextQBtn.onclick = () => loadNextQuestion(true);

            prevQBtnBottom.onclick = loadPreviousQuestion;
            nextQBtnBottom.onclick = () => loadNextQuestion(true);

            hintSoundBtn.onclick = () => {
                isSoundHintVisible = !isSoundHintVisible;
                updateHintDisplays();
                hintSoundBtn.classList.toggle('active', isSoundHintVisible);
            };

            hintRuleBtn.onclick = () => {
                isRuleHintVisible = !isRuleHintVisible;
                updateHintDisplays();
                hintRuleBtn.classList.toggle('active', isRuleHintVisible);
            };

            hintAnswerBtn.onclick = () => {
                isAnswerHintVisible = !isAnswerHintVisible;
                updateHintDisplays();
                hintAnswerBtn.classList.toggle('active', isAnswerHintVisible);
            };

            submitBtn.onclick = checkAnswer;
            answerInput.onkeyup = (e) => {
                if (e.key === 'Enter' && !submitBtn.disabled) checkAnswer();
            };
            nextBtn.onclick = () => loadNextQuestion(false);

            // ì •ë‹µ ëª¨ë‹¬ ë²„íŠ¼
            modalCloseBtn.onclick = hideCorrectModal;
            modalNextBtn.onclick = () => {
                hideCorrectModal();
                loadNextQuestion(false);
            };

            // [ìš”ì²­ ì‚¬í•­] í€´ì¦ˆ ì™„ë£Œ ëª¨ë‹¬ ë²„íŠ¼
            quizCompleteCloseBtn.onclick = hideQuizCompleteModal;
            quizCompleteHomeBtn.onclick = () => {
                window.location.href = 'index.html'; // í™ˆ(ì¸ë±ìŠ¤) í˜ì´ì§€ë¡œ ì´ë™
            };
        }


        // UI ìƒíƒœë¥¼ ì„¤ì •í•˜ëŠ” ë‘ ê°œì˜ ìƒˆ í•¨ìˆ˜

        /** (A) ë¬¸ì œê°€ 'ë¯¸ì™„ë£Œ' ìƒíƒœì¼ ë•Œì˜ UIë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. */
        function setUIStateActive() {
            // ì œì¶œ ê´€ë ¨ ë²„íŠ¼ í™œì„±í™”
            answerInput.disabled = false;
            submitBtn.disabled = false;
            submitBtn.textContent = "ì œì¶œí•˜ê¸°";

            // ì˜¤ë””ì˜¤/íŒíŠ¸ ë²„íŠ¼ í™œì„±í™”
            [...allAudioButtons, ...allHintButtons].forEach(el => el.disabled = false);

            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            const isFirst = (currentQuestionIndex === 0);
            const isLast = (currentQuestionIndex === quizSet.length - 1);

            prevQBtn.classList.toggle('disabled', isFirst);
            prevQBtnBottom.disabled = isFirst;
            nextQBtn.classList.toggle('disabled', isLast);
            nextQBtnBottom.disabled = isLast;
        }

        /** (B) ë¬¸ì œê°€ 'í•™ìŠµ ì™„ë£Œ' ìƒíƒœì¼ ë•Œì˜ UIë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. (ë³µìŠµ ê°€ëŠ¥) */
        function setUIStateCompleted() {
            // ì œì¶œ ê´€ë ¨ ë²„íŠ¼ ë¹„í™œì„±í™” ë° í…ìŠ¤íŠ¸ ë³€ê²½
            answerInput.disabled = true;
            submitBtn.disabled = true;
            submitBtn.textContent = "í•™ìŠµ ì™„ë£Œ";

            // ì˜¤ë””ì˜¤/íŒíŠ¸ ë²„íŠ¼ í™œì„±í™” (ë³µìŠµìš©)
            [...allAudioButtons, ...allHintButtons].forEach(el => el.disabled = false);

            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (í™œì„±í™”)
            const isFirst = (currentQuestionIndex === 0);
            const isLast = (currentQuestionIndex === quizSet.length - 1);

            prevQBtn.classList.toggle('disabled', isFirst);
            prevQBtnBottom.disabled = isFirst;
            nextQBtn.classList.toggle('disabled', isLast);
            nextQBtnBottom.disabled = isLast;

            // ìƒë‹¨ ë¬¸ì œ ëª©ë¡ UI ì—…ë°ì´íŠ¸
            const currentProblemEl = document.getElementById(`problem-item-${currentQuestionIndex}`);
            if (currentProblemEl) {
                currentProblemEl.classList.remove('current', 'blurred');
                currentProblemEl.classList.add('completed');
            }
        }


        // --- 5. í•µì‹¬ ê¸°ëŠ¥: ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸° ---
        function loadQuestion(index) {
            stopAudioLoop();

            currentQuestionIndex = index;
            currentQuestion = quizSet[index];

            progressIndicator.textContent = `ë¬¸ì œ ${index + 1} / ${quizSet.length}`;

            // 1. ì˜¤ë””ì˜¤ ì„¤ì •
            const audioFileName = currentQuestion[keyForAudio];
            if (!audioFileName || audioFileName.trim() === "") {
                feedbackArea.innerHTML = "ì˜¤ë””ì˜¤ íŒŒì¼ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ ë¬¸ì œëŠ” ê±´ë„ˆëœë‹ˆë‹¤.";
                feedbackArea.className = 'incorrect';
                disableAllControls(false);
                setTimeout(() => loadNextQuestion(true), 2000);
                return;
            }

            // Determine folder based on quiz type
            const audioFolder = keyForAudio.includes("Word") ? "audio1" : "audio2";

            currentAudio = new Audio(`${audioFolder}/${audioFileName}`);
            currentAudio.onerror = () => {
                feedbackArea.innerHTML = `ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                feedbackArea.className = 'incorrect';
                allAudioButtons.forEach(btn => btn.disabled = true);
            };

            // 2. ë¬¸ì œ ëª©ë¡ UI ì—…ë°ì´íŠ¸
            const prevProblemEl = document.querySelector('.problem-list-item.current');
            if (prevProblemEl) {
                prevProblemEl.classList.remove('current');
            }
            const currentProblemEl = document.getElementById(`problem-item-${currentQuestionIndex}`);
            if (currentProblemEl) {
                currentProblemEl.classList.add('current');
                // ë§Œì•½ ì´ë¯¸ ì™„ë£Œëœ ë¬¸ì œë¼ë©´ 'completed' í´ë˜ìŠ¤ë„ ì¶”ê°€
                if (currentQuestion.isCompleted) {
                    currentProblemEl.classList.remove('blurred');
                    currentProblemEl.classList.add('completed');
                }
            }

            // 3. UI ì´ˆê¸°í™” (íŒíŠ¸ ë“±)
            answerInput.value = "";
            feedbackArea.innerHTML = "";
            feedbackArea.className = "";

            isSoundHintVisible = false;
            isRuleHintVisible = false;
            isAnswerHintVisible = false;
            updateHintDisplays();

            allHintButtons.forEach(btn => btn.classList.remove('active'));

            ruleHintData = {};
            isAllRulesVisible = false;

            nextBtn.style.display = 'none';

            // 4. ë¬¸ì œ ìƒíƒœì— ë”°ë¼ UI ì„¤ì •
            if (currentQuestion.isCompleted) {
                setUIStateCompleted();
            } else {
                setUIStateActive();
            }
        }

        // --- 6. í•µì‹¬ ê¸°ëŠ¥: ì˜¤ë””ì˜¤ ì¬ìƒ ---
        function playAudio(times, interval, rate) {
            stopAudioLoop();
            if (!currentAudio || !currentAudio.src) return;
            let count = 0;
            function play() {
                if (count >= times) { audioPlayLoopId = null; return; }
                count++;
                currentAudio.playbackRate = rate;
                currentAudio.currentTime = 0;
                currentAudio.onended = () => {
                    if (count < times) { audioPlayLoopId = setTimeout(play, interval); }
                    else { audioPlayLoopId = null; }
                };
                currentAudio.play().catch(e => { console.error("ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:", e); });
            }
            play();
        }

        function playAllAudio() {
            stopAudioLoop();

            allAudioPlayer.isPlaying = true;
            allAudioPlayer.index = 0;

            [play1Btn, play3Btn, play5Btn, playSlowBtn, submitBtn, prevQBtnBottom, nextQBtnBottom].forEach(btn => btn.disabled = true);
            playAllBtn.textContent = "â–  ì¤‘ì§€";

            playNextInAll();
        }

        function playNextInAll() {
            if (allAudioPlayer.index >= quizSet.length || !allAudioPlayer.isPlaying) {
                stopPlayAllAudio();
                return;
            }

            const item = quizSet[allAudioPlayer.index];
            const audioFileName = item[keyForAudio];

            if (!audioFileName) {
                allAudioPlayer.index++;
                playNextInAll();
                return;
            }

            const currentProblemEl = document.querySelector('.problem-list-item.current');
            if (currentProblemEl) currentProblemEl.classList.remove('current');
            document.getElementById(`problem-item-${allAudioPlayer.index}`).classList.add('current');
            progressIndicator.textContent = `ì „ì²´ ë“£ê¸° (${allAudioPlayer.index + 1} / ${quizSet.length})`;

            const audioFolder = keyForAudio.includes("Word") ? "audio1" : "audio2";

            allAudioPlayer.audio = new Audio(`${audioFolder}/${audioFileName}`);
            allAudioPlayer.audio.onended = () => {
                allAudioPlayer.index++;
                allAudioPlayer.timeoutId = setTimeout(playNextInAll, 1000);
            };
            allAudioPlayer.audio.onerror = () => {
                allAudioPlayer.index++;
                playNextInAll();
            };
            allAudioPlayer.audio.play();
        }

        function stopAudioLoop() {
            if (audioPlayLoopId) { clearTimeout(audioPlayLoopId); audioPlayLoopId = null; }
            if (currentAudio) { currentAudio.pause(); currentAudio.onended = null; }

            stopPlayAllAudio();
        }

        function stopPlayAllAudio() {
            if (!allAudioPlayer.isPlaying) return;

            allAudioPlayer.isPlaying = false;
            if (allAudioPlayer.timeoutId) { clearTimeout(allAudioPlayer.timeoutId); }
            if (allAudioPlayer.audio) { allAudioPlayer.audio.pause(); }

            allAudioPlayer.timeoutId = null;
            allAudioPlayer.audio = null;

            playAllBtn.textContent = "ğŸ”Š ì „ì²´";
            loadQuestion(currentQuestionIndex);
        }

        // --- 7. íŒíŠ¸ UI í†µí•© ì—…ë°ì´íŠ¸ ---
        function updateHintDisplays() {
            if (!currentQuestion) return;

            const correctAnswer = currentQuestion[keyForAnswer];
            const soundHint = currentQuestion[keyForSoundHint];

            const normalizedCorrectAnswer = normalizeText(correctAnswer);
            const normalizedSoundHint = normalizeText(soundHint);

            let answerContentHtml = `<div class="hint-content-box">${normalizedCorrectAnswer}</div>`;
            let soundContentHtml = `<div class="hint-content-box">${normalizedSoundHint}</div>`;

            if (isAnswerHintVisible && isSoundHintVisible) {
                const diff = generateDiffHtml(normalizedCorrectAnswer, normalizedSoundHint);
                answerContentHtml = `<div class="hint-content-box">${diff.html1}</div>`;
                soundContentHtml = `<div class="hint-content-box">${diff.html2}</div>`;
            }

            if (isAnswerHintVisible) {
                hintDisplayAnswer.innerHTML = `<div class="hint-label-box"><strong>ğŸ‘€ ì •ë‹µ</strong></div>
                                                ${answerContentHtml}`;
                hintDisplayAnswer.style.display = 'grid';
            } else {
                hintDisplayAnswer.style.display = 'none';
            }

            if (isSoundHintVisible) {
                hintDisplaySound.innerHTML = `<div class="hint-label-box"><strong>ğŸ’¡ ì†Œë¦¬ íŒíŠ¸</strong></div>
                                                ${soundContentHtml}`;
                hintDisplaySound.style.display = 'grid';
            } else {
                hintDisplaySound.style.display = 'none';
            }

            if (isRuleHintVisible) {
                showRuleHintOptions();
                hintDisplayRule.style.display = 'block';
            } else {
                hintDisplayRule.innerHTML = '';
                hintDisplayRule.style.display = 'none';
            }
        }

        function generateDiffHtml(str1, str2) {
            let html1 = '';
            let html2 = '';
            const len = Math.max(str1.length, str2.length);

            for (let i = 0; i < len; i++) {
                const char1 = str1[i] || '';
                const char2 = str2[i] || '';

                if (char1 === char2) {
                    html1 += `<span class="diff-char-black">${char1}</span>`;
                    html2 += `<span class="diff-char-black">${char2}</span>`;
                } else {
                    html1 += `<span class="diff-char-red">${char1}</span>`;
                    html2 += `<span class="diff-char-red">${char2}</span>`;
                }
            }
            return { html1: html1, html2: html2 };
        }


        // --- 7. ê·œì¹™ íŒíŠ¸ UI ìƒì„± ---
        function showRuleHintOptions() {
            let ruleHtml = '<strong style="margin-top:0;">ğŸ§© ì ìš© ê·œì¹™</strong>';
            let ruleButtonsHtml = '<div id="rule-hint-buttons">';

            let ruleCount = 0;

            if (Object.keys(ruleHintData).length === 0) {
                if (!currentQuestion) return;
                for (let i = 0; i < 5; i++) {
                    const ruleTitleKey = keyForRules[i];
                    const ruleHintKey = keyForHints[i];

                    if (currentQuestion[ruleTitleKey]) {
                        const title = currentQuestion[ruleTitleKey];
                        const hint = currentQuestion[ruleHintKey] || "íŒíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.";

                        ruleHintData[title] = {
                            title: title,
                            hint: hint.replace(/'/g, "\\'"),
                            visible: false
                        };
                    }
                }
            }

            const ruleTitles = Object.keys(ruleHintData);
            ruleCount = ruleTitles.length;

            if (ruleCount === 0) {
                ruleHtml += "<p>ì´ ë¬¸ì œì— ë“±ë¡ëœ ê·œì¹™ íŒíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
            } else {
                ruleButtonsHtml += `<button class="rule-hint-btn show-all ${isAllRulesVisible ? 'active' : ''}" 
                                            onclick="toggleAllRules(this)">ì „ì²´</button>`;

                ruleTitles.forEach((title, index) => {
                    const data = ruleHintData[title];

                    const ruleNumMatch = title.match(/^(\d+)ë²ˆ/);
                    const buttonText = ruleNumMatch ? `ê·œì¹™ ${ruleNumMatch[1]}` : `ê·œì¹™ ${index + 1}`;

                    ruleButtonsHtml += `<button class="rule-hint-btn ${data.visible ? 'active' : ''}" 
                                                onclick="toggleRuleHint('${title}', this)">${buttonText}</button>`;
                });

                ruleHtml += ruleButtonsHtml + '</div>';
                ruleHtml += '<div id="rule-hint-text-area" style="margin-top: 15px;"></div>';
            }

            hintDisplayRule.innerHTML = ruleHtml;

            renderRuleHintText();
        }

        function toggleRuleHint(title, btn) {
            const data = ruleHintData[title];
            data.visible = !data.visible;
            renderRuleHintText();
            btn.classList.toggle('active', data.visible);
        }

        function toggleAllRules(btn) {
            isAllRulesVisible = !isAllRulesVisible;

            for (const title in ruleHintData) {
                ruleHintData[title].visible = isAllRulesVisible;
            }
            renderRuleHintText();
            showRuleHintOptions();
        }

        function renderRuleHintText() {
            const textArea = document.getElementById('rule-hint-text-area');
            if (!textArea) return;

            textArea.innerHTML = '';

            for (const title in ruleHintData) {
                const data = ruleHintData[title];
                if (data.visible) {
                    const displayTitle = data.title.replace(/^(.*?ë²ˆ)(?=[^ ])/g, '$1_');

                    let linkHtml = '';
                    const ruleNumMatch = data.title.match(/^(\d+)ë²ˆ/);
                    if (ruleNumMatch && ruleNumMatch[1]) {
                        const ruleNum = parseInt(ruleNumMatch[1], 10);
                        const linkFile = ruleFileMap[ruleNum];
                        if (linkFile) {
                            linkHtml = `<a href="rules/${linkFile}" class="rule-link-icon" target="_blank" title="ìì„¸íˆ ë³´ê¸°">${bookIconEmoji}</a>`;
                        }
                    }

                    textArea.innerHTML += `<div style="margin-bottom: 10px;">
                            <strong style="color:var(--color-secondary);">${displayTitle}</strong>
                            ${linkHtml}
                            <br>
                            <span>${data.hint.replace(/\\'/g, "'")}</span>
                        </div>`;
                }
            }
        }


        // --- 8. í•µì‹¬ ê¸°ëŠ¥: ì •ë‹µ í™•ì¸ ë° ì²˜ë¦¬ ---
        function checkAnswer() {
            const normalizedUserAnswer = normalizeText(answerInput.value.trim());
            const normalizedCorrectAnswer = normalizeText(currentQuestion[keyForAnswer]);

            if (normalizedUserAnswer === normalizedCorrectAnswer) {
                currentQuestion.isCompleted = true;
                setUIStateCompleted();

                // [ìš”ì²­ ì‚¬í•­] ëª¨ë“  í€´ì¦ˆê°€ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
                checkIfAllCompleted();

            } else {
                feedbackArea.innerHTML = "ğŸ˜¥ ì•„ë‹™ë‹ˆë‹¤. ë‹¤ì‹œ ìƒê°í•´ë³´ì„¸ìš”. (íŒíŠ¸ë¥¼ ì‚¬ìš©í•´ë³¼ê¹Œìš”?)";
                feedbackArea.className = 'incorrect';
                answerInput.focus();
            }
        }

        // [ìš”ì²­ ì‚¬í•­] ëª¨ë“  í€´ì¦ˆ ì™„ë£Œ ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜ (ì‹ ê·œ)
        function checkIfAllCompleted() {
            // .every()ëŠ” ëª¨ë“  ìš”ì†Œê°€ ì¡°ê±´ì„ ë§Œì¡±í•  ë•Œ trueë¥¼ ë°˜í™˜
            const allCompleted = quizSet.every(item => item.isCompleted === true);

            if (allCompleted) {
                // ëª¨ë“  í€´ì¦ˆë¥¼ ì™„ë£Œí–ˆìœ¼ë©´, 'í€´ì¦ˆ ì™„ë£Œ' íŒì—…ì„ ë„ì›ë‹ˆë‹¤.
                showQuizCompleteModal();
            } else {
                // ì•„ì§ ë‚¨ì•˜ìœ¼ë©´, 'ì •ë‹µ' íŒì—…ì„ ë„ì›ë‹ˆë‹¤.
                showCorrectModal();
            }
        }

        function showCorrectModal() {
            mainContent.classList.add('grayscale');
            modalOverlay.style.display = 'flex';

            if (currentQuestionIndex === quizSet.length - 1) {
                modalNextBtn.style.display = 'none';
            } else {
                modalNextBtn.style.display = 'block';
            }
        }

        function hideCorrectModal() {
            mainContent.classList.remove('grayscale');
            modalOverlay.style.display = 'none';

            // [ìš”ì²­ ì‚¬í•­] ì´ ë¶€ë¶„ì—ì„œ 'handleQuizComplete' í˜¸ì¶œ ë¡œì§ ì œê±°
            // (ì´ë¯¸ 'checkIfAllCompleted'ê°€ ì²˜ë¦¬í•¨)
        }

        function showQuizCompleteModal() {
            mainContent.classList.add('grayscale');
            quizCompleteModalOverlay.style.display = 'flex';
        }

        function hideQuizCompleteModal() {
            mainContent.classList.remove('grayscale');
            quizCompleteModalOverlay.style.display = 'none';
        }

        function handleNoQuestions() {
            mainContent.innerHTML = `<h1>ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤</h1>
                                     <p>ì„ íƒí•˜ì‹  ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                                     <a href="index.html" style="display:inline-block; margin-top:20px; padding:10px 20px; background-color:#5cb85c; color:white; text-decoration:none; border-radius:5px;">ëŒì•„ê°€ê¸°</a>`;
        }

        function disableAllControls(disable) {
            [answerInput, submitBtn, ...allAudioButtons, ...allHintButtons].forEach(el => el.disabled = disable);
        }

        function loadNextQuestion(autoPlay) {
            if (currentQuestionIndex < quizSet.length - 1) {
                loadQuestion(currentQuestionIndex + 1);
                if (autoPlay) {
                    // ìë™ ì¬ìƒ ë¡œì§ì´ í•„ìš”í•˜ë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€
                    // playAudio(1, 0, 1.0); 
                }
            }
        }

        function loadPreviousQuestion() {
            if (currentQuestionIndex > 0) {
                loadQuestion(currentQuestionIndex - 1);
            }
        }

    </script>
</body>

</html>