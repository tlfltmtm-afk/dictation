<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ë˜ë°›ì“° - ë°›ì•„ì“°ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fonts-archive/Paperlogy/subsets/Paperlogy-dynamic-subset.css" type="text/css"/>
    <meta name="theme-color" content="#FFD700">
    <style>
        /* ê¸°ë³¸ í°íŠ¸ ë° ë°°ê²½ ì„¤ì • */
        body {
            font-family: "Paperlogy", sans-serif;
            background-color: #FFFBEB; /* amber-50 */
            padding-top: 70px;
            padding-bottom: 40px;
            color: #4B5563;
        }

        /* ìƒë‹¨ë°” ìŠ¤íƒ€ì¼ */
        .header-fixed {
            position: fixed; top: 0; left: 0; right: 0; z-index: 50;
            background-color: #FFD700; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: 56px;
        }
        
        .nav-link {
            display: flex; align-items: center; justify-content: center;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            color: #1F2937;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: #FBBF24; /* amber-400 */
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        main {
            transition: filter 0.3s ease-in-out;
        }
        main.grayscale {
            filter: grayscale(100%);
        }

        /* ë¬¸ì œ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .problem-list-item {
            transition: all 0.3s ease;
            user-select: none;
        }
        .problem-list-item.blurred {
            filter: blur(4px);
            color: transparent;
            background-color: #E5E7EB; /* gray-200 */
            border-color: #D1D5DB;
        }
        .problem-list-item.completed {
            filter: none;
            background-color: #ffffff;
            color: #4B5563;
            border-color: #FCD34D; /* amber-300 */
        }
        .problem-list-item.current {
            background-color: #F59E0B; /* amber-500 */
            color: white;
            border-color: #D97706;
            transform: scale(1.1);
            font-weight: bold;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        /* íŒíŠ¸ ë° í”¼ë“œë°± ìŠ¤íƒ€ì¼ */
        #feedback-area.correct { color: #059669; font-weight: bold; } /* emerald-600 */
        #feedback-area.incorrect { color: #DC2626; font-weight: bold; } /* red-600 */

        .diff-char-red { color: #DC2626; font-weight: bold; }
        .diff-char-black { color: #1F2937; }

        /* íŒíŠ¸ ë°•ìŠ¤ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
        .hint-display {
            display: none;
            background-color: white;
            border-radius: 12px;
            margin-top: 12px;
            border: 1px solid #E5E7EB;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .hint-display.two-column {
            grid-template-columns: 100px 1fr;
            gap: 0;
            align-items: stretch;
        }
        .hint-label-box {
            background-color: #FEF3C7; /* amber-100 */
            padding: 12px;
            display: flex; align-items: center; justify-content: center;
            color: #92400E; /* amber-800 */
            font-weight: bold;
            border-right: 1px solid #FDE68A;
        }
        .hint-content-box {
            padding: 12px;
            display: flex; 
            flex-direction: column; /* ì„¸ë¡œ ì •ë ¬ì„ ìœ„í•´ ë³€ê²½ */
            align-items: center; 
            justify-content: center;
            font-size: 1.1rem;
            word-break: keep-all;
            text-align: center;
            gap: 8px; /* í…ìŠ¤íŠ¸ì™€ ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; justify-content: center; align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: #FFFBEB; /* amber-50 */
            border-radius: 24px;
            padding: 32px;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 90%; max-width: 400px;
            border: 4px solid #FCD34D;
        }

        /* ê·œì¹™ íŒíŠ¸ ë²„íŠ¼ */
        .rule-hint-btn.active {
            background-color: #F59E0B; color: white; border-color: #D97706;
        }
        
        /* íˆ´íŒ */
        .tooltip-container { position: relative; }
        .tooltip-container::after {
            content: attr(data-tooltip);
            position: absolute; bottom: -40px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8); color: white;
            padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; white-space: nowrap;
            opacity: 0; visibility: hidden; transition: opacity 0.2s; pointer-events: none;
        }
        .tooltip-container:hover::after { opacity: 1; visibility: visible; }

        /* ì¶”ê°€ íŒíŠ¸ ë²„íŠ¼ (2ë‹¨ê³„) ìŠ¤íƒ€ì¼ */
        .stage2-trigger-btn {
            font-size: 1rem;
            padding: 4px 8px;
            border-radius: 12px;
            background-color: #EFF6FF; /* blue-50 */
            color: #2563EB; /* blue-600 */
            border: 1px dashed #BFDBFE; /* blue-200 */
            cursor: pointer;
            transition: all 0.2s;
            /* margin-top: 4px; ì œê±° */
        }
        .stage2-trigger-btn:hover {
            background-color: #DBEAFE;
            border-color: #3B82F6;
        }
    </style>
</head>

<body class="antialiased">

    <header class="header-fixed flex items-center justify-center px-4">
        <nav class="flex items-center space-x-3">
            <a href="index.html" class="nav-link tooltip-container" aria-label="í™ˆ" data-tooltip="í™ˆìœ¼ë¡œ ì´ë™">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            </a>
            <a href="test.html" class="nav-link" aria-label="ê¸‰ìˆ˜">ê¸‰ìˆ˜</a>
            <a href="list.html" class="nav-link" aria-label="ëª©ì°¨">ëª©ì°¨</a>
            <a href="quiz.html" class="nav-link active" aria-label="í€´ì¦ˆ">í€´ì¦ˆ</a>
            <a href="rules.html" class="nav-link" aria-label="ë¹„ë²•">ë¹„ë²•</a>
        </nav>
    </header>

    <main id="main-content" class="max-w-2xl mx-auto px-4">
        
        <div class="relative text-center mb-6 mt-4">
            <h1 class="text-3xl font-bold text-amber-900 flex items-center justify-center gap-2">
                <span>âœï¸</span> ê±°ê¾¸ë¡œ ë°›ì•„ì“°ê¸°
            </h1>
            <a href="rules.html" id="info-link" target="_blank" class="absolute right-0 top-1 text-2xl opacity-70 hover:opacity-100 transition-opacity" title="ê·œì¹™ ì„¤ëª… ë³´ê¸°">ğŸ“š</a>
        </div>

        <div id="audio-controls-container" class="grid grid-cols-5 gap-2 mb-6">
            <button id="play-slow" class="py-2 rounded-xl bg-sky-100 text-sky-700 font-bold hover:bg-sky-200 transition shadow-sm text-sm sm:text-base">ëŠë¦¬ê²Œ</button>
            <button id="play-1" class="py-2 rounded-xl bg-amber-100 text-amber-800 font-bold hover:bg-amber-200 transition shadow-sm text-sm sm:text-base">1íšŒ</button>
            <button id="play-3" class="py-2 rounded-xl bg-amber-100 text-amber-800 font-bold hover:bg-amber-200 transition shadow-sm text-sm sm:text-base">3íšŒ</button>
            <button id="play-5" class="py-2 rounded-xl bg-amber-100 text-amber-800 font-bold hover:bg-amber-200 transition shadow-sm text-sm sm:text-base">5íšŒ</button>
            <button id="play-all" class="py-2 rounded-xl bg-rose-100 text-rose-700 font-bold hover:bg-rose-200 transition shadow-sm text-sm sm:text-base">ì „ì²´</button>
        </div>

        <div id="problem-list-container" class="flex flex-wrap gap-2 justify-center mb-8 p-4 bg-white rounded-2xl shadow-inner border border-amber-100 min-h-[80px] items-center">
            <div class="text-gray-400 text-sm">ë¬¸ì œ ë¡œë”© ì¤‘...</div>
        </div>

        <div id="q-nav-container" class="flex justify-between items-center px-4 mb-4">
            <button id="prev-q-btn" class="text-3xl text-amber-300 hover:text-amber-500 transition disabled:text-gray-200 disabled:cursor-not-allowed">â—€</button>
            <div id="progress-indicator" class="text-lg font-bold text-amber-800">ì¤€ë¹„ ì¤‘...</div>
            <button id="next-q-btn" class="text-3xl text-amber-300 hover:text-amber-500 transition disabled:text-gray-200 disabled:cursor-not-allowed">â–¶</button>
        </div>

        <input type="text" id="answer-input" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" 
            class="w-full text-center text-xl p-4 border-2 border-amber-300 rounded-2xl focus:outline-none focus:ring-4 focus:ring-amber-200 focus:border-amber-500 transition mb-4 shadow-sm placeholder-amber-300 bg-white">

        <div id="submission-area" class="flex gap-2 mb-2">
            <button id="prev-q-btn-bottom" class="flex-1 bg-gray-400 text-white rounded-xl py-3 font-bold hover:bg-gray-500 transition shadow text-xl disabled:bg-gray-200 disabled:cursor-not-allowed">â—€</button>
            <button id="submit-btn" class="flex-[3] bg-amber-500 text-white rounded-xl py-3 text-xl font-bold hover:bg-amber-600 transition shadow-md active:scale-95 disabled:bg-amber-200 disabled:cursor-not-allowed">ì œì¶œí•˜ê¸°</button>
            <button id="next-q-btn-bottom" class="flex-1 bg-gray-400 text-white rounded-xl py-3 font-bold hover:bg-gray-500 transition shadow text-xl disabled:bg-gray-200 disabled:cursor-not-allowed">â–¶</button>
        </div>

        <div id="feedback-area" class="h-8 text-center text-lg mb-6"></div>

        <hr class="border-amber-200 mb-6">

        <div id="hint-container" class="grid grid-cols-3 gap-3 mb-6">
            <button id="hint-sound" class="py-3 bg-white border-2 border-amber-200 text-amber-800 rounded-xl font-bold hover:bg-amber-50 transition shadow-sm">ğŸ’¡ ì†Œë¦¬ íŒíŠ¸</button>
            <button id="hint-rule" class="py-3 bg-white border-2 border-amber-200 text-amber-800 rounded-xl font-bold hover:bg-amber-50 transition shadow-sm">ğŸ§© ê·œì¹™ íŒíŠ¸</button>
            <button id="hint-answer" class="py-3 bg-white border-2 border-amber-200 text-amber-800 rounded-xl font-bold hover:bg-amber-50 transition shadow-sm">ğŸ‘€ ì •ë‹µ ë³´ê¸°</button>
        </div>

        <div id="result-area" class="space-y-3 mb-10">
            <!-- ìˆœì„œ ë³€ê²½: ì •ë‹µì´ ì†Œë¦¬ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ ë°°ì¹˜ -->
            <div id="hint-display-answer" class="hint-display two-column border-amber-400 ring-2 ring-amber-100"></div>
            <div id="hint-display-sound" class="hint-display two-column border-blue-200"></div>
            <div id="hint-display-rule" class="hint-display p-4 bg-gray-50"></div>
        </div>

        <div id="navigation-area" class="flex justify-between items-center mt-8">
            <a href="index.html" id="back-link" class="text-amber-600 font-bold hover:underline flex items-center">
                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                ë²”ìœ„ ì„ íƒìœ¼ë¡œ
            </a>
            <button id="next-btn" style="display: none;" class="bg-gray-800 text-white px-6 py-3 rounded-xl font-bold hover:bg-black transition">ë‹¤ìŒ ë¬¸ì œ â”</button>
        </div>
    </main>

    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content">
            <div class="w-32 h-32 rounded-full border-8 border-amber-500 flex items-center justify-center mx-auto mb-6 bg-white animate-bounce">
                <span class="text-6xl">â­•</span>
            </div>
            <div id="modal-text" class="text-2xl font-bold text-gray-800 mb-8">ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤!</div>
            <div id="modal-buttons" class="flex gap-3">
                <button id="modal-close-btn" class="flex-1 py-3 bg-gray-200 text-gray-600 rounded-xl font-bold hover:bg-gray-300 transition">ë‹«ê¸°</button>
                <button id="modal-next-btn" class="flex-1 py-3 bg-amber-500 text-white rounded-xl font-bold hover:bg-amber-600 transition shadow">ë‹¤ìŒ ë¬¸ì œ â”</button>
            </div>
        </div>
    </div>

    <div id="quiz-complete-modal-overlay" class="modal-overlay">
        <div id="quiz-complete-modal-content" class="modal-content">
            <div class="text-6xl mb-4">ğŸ‘‘</div>
            <div id="quiz-complete-modal-text" class="text-2xl font-bold text-gray-800 mb-2">ëª¨ë“  í€´ì¦ˆ ì™„ë£Œ!</div>
            <p class="text-gray-600 mb-8 leading-relaxed">ì¶•í•˜í•©ë‹ˆë‹¤! <br>í•™ìŠµì„ í›Œë¥­í•˜ê²Œ ë§ˆì¹˜ì…¨ìŠµë‹ˆë‹¤.</p>
            <div id="quiz-complete-modal-buttons" class="flex gap-3">
                <button id="quiz-complete-close-btn" class="flex-1 py-3 bg-gray-200 text-gray-600 rounded-xl font-bold hover:bg-gray-300 transition">ë‹«ê¸°</button>
                <button id="quiz-complete-home-btn" class="flex-1 py-3 bg-amber-500 text-white rounded-xl font-bold hover:bg-amber-600 transition shadow">í™ˆìœ¼ë¡œ ì´ë™</button>
            </div>
        </div>
    </div>

    <script src="database.js"></script>

    <script>
        /* global quizData */

        // --- 1. ì „ì—­ ë³€ìˆ˜ ---
        let quizSet = [];
        let currentQuestionIndex = 0;
        let currentQuestion = null;
        let currentAudio = null;
        let audioPlayLoopId = null;

        let allAudioPlayer = {
            index: 0,
            timeoutId: null,
            audio: null,
            isPlaying: false
        };

        // íŒíŠ¸/ì„¤ì • í‚¤ê°’
        let keyForAudio, keyForAnswer, keyForSoundHint, keyForRules, keyForHints;
        let placeholderText;

        // íŒíŠ¸ ìƒíƒœ
        let isSoundHintVisible = false;
        let isSoundHintStage2Visible = false; // ì†Œë¦¬ íŒíŠ¸ 2ë‹¨ê³„(ë¹¨ê°„ìƒ‰ ê°•ì¡°) í™œì„±í™” ì—¬ë¶€
        let isRuleHintVisible = false;
        let isAnswerHintVisible = false;
        let ruleHintData = {};
        let isAllRulesVisible = false;

        const ruleFileMap = {
            1: 'rule01_yeonum.html', 2: 'rule02_eumjeol_kkwessori.html', 3: 'rule03_jaeumgun_dansunhwa.html',
            4: 'rule04_doensori_doegi.html', 5: 'rule05_jaeum_donghwa.html', 6: 'rule06_gugaeumhwa.html',
            7: 'rule07_jaeum_chukyak.html', 8: 'rule08_h_tallak.html', 9: 'rule09_moeum_chukyak.html',
            10: 'rule10_n_cheomga.html', 11: 'rule11_dueum_beopchik.html', 12: 'rule12_ttyeossuegi.html',
            13: 'rule13_ssangdungyi_moeum.html', 14: 'rule14_sori_pyogi.html'
        };

        // DOM Elements
        const mainContent = document.getElementById('main-content');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalNextBtn = document.getElementById('modal-next-btn');
        const quizCompleteModalOverlay = document.getElementById('quiz-complete-modal-overlay');
        const quizCompleteCloseBtn = document.getElementById('quiz-complete-close-btn');
        const quizCompleteHomeBtn = document.getElementById('quiz-complete-home-btn');
        const problemListContainer = document.getElementById('problem-list-container');
        const progressIndicator = document.getElementById('progress-indicator');
        const prevQBtn = document.getElementById('prev-q-btn');
        const nextQBtn = document.getElementById('next-q-btn');
        const answerInput = document.getElementById('answer-input');
        const submitBtn = document.getElementById('submit-btn');
        const prevQBtnBottom = document.getElementById('prev-q-btn-bottom');
        const nextQBtnBottom = document.getElementById('next-q-btn-bottom');
        const feedbackArea = document.getElementById('feedback-area');
        const hintDisplayAnswer = document.getElementById('hint-display-answer');
        const hintDisplaySound = document.getElementById('hint-display-sound');
        const hintDisplayRule = document.getElementById('hint-display-rule');
        const nextBtn = document.getElementById('next-btn');
        
        // Buttons
        const playSlowBtn = document.getElementById('play-slow');
        const play1Btn = document.getElementById('play-1');
        const play3Btn = document.getElementById('play-3');
        const play5Btn = document.getElementById('play-5');
        const playAllBtn = document.getElementById('play-all');
        const hintSoundBtn = document.getElementById('hint-sound');
        const hintRuleBtn = document.getElementById('hint-rule');
        const hintAnswerBtn = document.getElementById('hint-answer');

        const allAudioButtons = [play1Btn, play3Btn, play5Btn, playSlowBtn, playAllBtn];
        const allHintButtons = [hintSoundBtn, hintRuleBtn, hintAnswerBtn];
        const bookIconEmoji = 'ğŸ“š';

        // --- 2. í—¬í¼ í•¨ìˆ˜ ---
        function normalizeText(text) {
            if (typeof text !== 'string') return "";
            return text.replace(/[.,!?~"'"\[\]]/g, '');
        }

        function setupQuizType(quizType) {
            if (quizType === 'sentence') {
                keyForAudio = "Audio File Name (Sentence)";
                keyForAnswer = "Sentence Notation";
                keyForSoundHint = "Sentence sound notation";
                keyForRules = ["Syllable 1 Rule", "Syllable 2 rule", "Syllable 3 Rule", "Syllable 4 Rule", "Syllable 5 Rule"];
                keyForHints = ["Syllable 1 Rule", "Syllable 2 rule", "Syllable 3 Rule", "Syllable 4 Rule", "Syllable 5 Rule"];
                placeholderText = "ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”.(ë„ì–´ì“°ê¸° í¬í•¨)";
            } else {
                keyForAudio = "Audio File Name (Word)";
                keyForAnswer = "Word Notation";
                keyForSoundHint = "Word phonetic notation";
                keyForRules = ["Syllable 1 Rule", "Syllable 2 rule", "Syllable 3 Rule", "Syllable 4 Rule", "Syllable 5 Rule"];
                keyForHints = ["Syllable 1 Rule", "Syllable 2 rule", "Syllable 3 Rule", "Syllable 4 Rule", "Syllable 5 Rule"];
                placeholderText = "ë‚±ë§ì„ ì…ë ¥í•˜ì„¸ìš”";
            }
            if (answerInput) answerInput.placeholder = placeholderText;
        }

        function filterQuizSet(grade, unit, rule, quizType) {
            const tempKeyForAnswer = (quizType === 'sentence') ? "Sentence Notation" : "Word Notation";

            quizSet = quizData.filter(item => {
                const gradeMatch = (grade === 'all' || item["Year/Semester"] === grade);
                const unitMatch = (unit === 'all' || item["Chapter"] === unit);
                let ruleMatch = (rule === 'all');
                if (rule !== 'all') {
                    const ruleKeys = ["Syllable 1 Rule", "Syllable 2 rule", "Syllable 3 Rule", "Syllable 4 Rule", "Syllable 5 Rule"];
                    for (const rK of ruleKeys) {
                        if (item[rK] === rule) {
                            ruleMatch = true; break;
                        }
                    }
                }
                const typeMatch = (quizType === 'word' || (item[tempKeyForAnswer] && item[tempKeyForAnswer].trim() !== ""));
                return gradeMatch && unitMatch && ruleMatch && typeMatch;
            });
        }

        function shuffleQuizSet() {
            for (let i = quizSet.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [quizSet[i], quizSet[j]] = [quizSet[j], quizSet[i]];
            }
        }

        // --- 3. ì´ˆê¸°í™” (ê°œìˆ˜ ì œí•œ ì ìš©) ---
        window.onload = () => {
            try {
                if (typeof quizData === 'undefined') {
                    throw new Error("database.jsë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆê±°ë‚˜ quizData ë³€ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }

                const params = new URLSearchParams(window.location.search);
                const mode = params.get('mode');

                if (mode === 'custom') {
                    // [ì»¤ìŠ¤í…€ ëª¨ë“œ]
                    const customData = sessionStorage.getItem('customQuizData');
                    if (!customData) {
                        alert("ì„ íƒëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. í™ˆìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.");
                        window.location.href = 'index.html';
                        return;
                    }
                    const selectedList = JSON.parse(customData);
                    quizSet = selectedList.map(item => {
                        const dataItem = quizData[item.index];
                        const newItem = Object.assign({}, dataItem);
                        newItem._quizType = item.type;
                        newItem.isCompleted = false;
                        return newItem;
                    });
                } else {
                    // [ì¼ë°˜ ëª¨ë“œ]
                    const grade = params.get('grade');
                    const unit = params.get('unit');
                    const rule = params.get('rule');
                    const quizType = params.get('type') || 'word';
                    
                    // [ê°œìˆ˜ ì œí•œ í•µì‹¬ ë¡œì§]
                    const pCount = parseInt(params.get('count')) || 10;

                    filterQuizSet(grade, unit, rule, quizType);
                    
                    quizSet.forEach(item => {
                        item._quizType = quizType;
                        item.isCompleted = false;
                    });
                    
                    shuffleQuizSet();

                    // â˜… ì„¤ì •í•œ ê°œìˆ˜ë§Œí¼ ìë¥´ê¸°
                    if (quizSet.length > pCount) {
                        quizSet = quizSet.slice(0, pCount);
                    }
                }

                if (quizSet.length > 0) {
                    generateProblemList();
                    loadQuestion(0);
                } else {
                    handleNoQuestions();
                }

                setupEventListeners();

            } catch (error) {
                console.error("ì˜¤ë¥˜ ë°œìƒ:", error);
                mainContent.innerHTML = `<h1 class="text-2xl font-bold text-red-600">ì˜¤ë¥˜ ë°œìƒ</h1><p>${error.message}</p>`;
            }
        };

        function generateProblemList() {
            problemListContainer.innerHTML = '';
            quizSet.forEach((item, index) => {
                const div = document.createElement('div');
                div.id = `problem-item-${index}`;
                // CSS í´ë˜ìŠ¤ ìˆ˜ì •: rounded-lg p-2 border ì¶”ê°€
                div.className = 'problem-list-item blurred rounded-lg px-3 py-1 border text-sm cursor-pointer';
                
                const type = item._quizType;
                const ansKey = (type === 'sentence') ? "Sentence Notation" : "Word Notation";
                div.textContent = item[ansKey] || "ë¬¸ì œ";
                
                div.onclick = () => {
                    if (index !== currentQuestionIndex) loadQuestion(index);
                };
                problemListContainer.appendChild(div);
            });
        }

        function setupEventListeners() {
            play1Btn.onclick = () => playAudio(1, 0, 1.0);
            play3Btn.onclick = () => playAudio(3, 1000, 1.0);
            play5Btn.onclick = () => playAudio(5, 1000, 1.0);
            playSlowBtn.onclick = () => playAudio(1, 0, 0.75);
            playAllBtn.onclick = playAllAudio;

            prevQBtn.onclick = loadPreviousQuestion;
            nextQBtn.onclick = () => loadNextQuestion(true);
            prevQBtnBottom.onclick = loadPreviousQuestion;
            nextQBtnBottom.onclick = () => loadNextQuestion(true);

            // ì†Œë¦¬ íŒíŠ¸ í† ê¸€
            hintSoundBtn.onclick = () => {
                isSoundHintVisible = !isSoundHintVisible;
                // ì†Œë¦¬ íŒíŠ¸ ë²„íŠ¼ì„ ë‹¤ì‹œ ê»ë‹¤ ì¼œë©´ 1ë‹¨ê³„(ê¸°ë³¸)ë¶€í„° ì‹œì‘
                if (!isSoundHintVisible) {
                    isSoundHintStage2Visible = false;
                }
                updateHintDisplays();
                hintSoundBtn.classList.toggle('bg-amber-100', isSoundHintVisible);
                hintSoundBtn.classList.toggle('border-amber-400', isSoundHintVisible);
            };

            // ê·œì¹™ íŒíŠ¸ í† ê¸€
            hintRuleBtn.onclick = () => {
                isRuleHintVisible = !isRuleHintVisible;
                updateHintDisplays();
                hintRuleBtn.classList.toggle('bg-amber-100', isRuleHintVisible);
                hintRuleBtn.classList.toggle('border-amber-400', isRuleHintVisible);
            };

            // ì •ë‹µ ë³´ê¸° í† ê¸€
            hintAnswerBtn.onclick = () => {
                isAnswerHintVisible = !isAnswerHintVisible;
                // ì •ë‹µ ë³´ê¸° í™œì„±í™” ì‹œ ìë™ìœ¼ë¡œ ì†Œë¦¬ íŒíŠ¸ 2ë‹¨ê³„ë„ ê°™ì´ í™œì„±í™”ë˜ì–´ì•¼ í•¨ (ë‹¨, í† ê¸€ ê°€ëŠ¥)
                if(isAnswerHintVisible) {
                    isSoundHintStage2Visible = true;
                }
                updateHintDisplays();
                hintAnswerBtn.classList.toggle('bg-amber-100', isAnswerHintVisible);
                hintAnswerBtn.classList.toggle('border-amber-400', isAnswerHintVisible);
            };

            submitBtn.onclick = checkAnswer;
            answerInput.onkeyup = (e) => {
                if (e.key === 'Enter' && !submitBtn.disabled) checkAnswer();
            };
            nextBtn.onclick = () => loadNextQuestion(false);

            modalCloseBtn.onclick = hideCorrectModal;
            modalNextBtn.onclick = () => { hideCorrectModal(); loadNextQuestion(false); };
            quizCompleteCloseBtn.onclick = hideQuizCompleteModal;
            quizCompleteHomeBtn.onclick = () => { window.location.href = 'index.html'; };
        }

        // --- 4. ë¬¸ì œ ë¡œë“œ ë° UI ---
        function loadQuestion(index) {
            stopAudioLoop();
            currentQuestionIndex = index;
            currentQuestion = quizSet[index];

            setupQuizType(currentQuestion._quizType);

            progressIndicator.textContent = `ë¬¸ì œ ${index + 1} / ${quizSet.length}`;

            // ì˜¤ë””ì˜¤ ì„¤ì •
            const audioFileName = currentQuestion[keyForAudio];
            if (!audioFileName || audioFileName.trim() === "") {
                feedbackArea.innerHTML = "ì˜¤ë””ì˜¤ ì—†ìŒ. ê±´ë„ˆëœë‹ˆë‹¤.";
                feedbackArea.className = 'incorrect';
                disableAllControls(false);
                setTimeout(() => loadNextQuestion(true), 1500);
                return;
            }

            const audioFolder = (currentQuestion._quizType === 'word') ? "audio1" : "audio2";
            let cleanAudioName = audioFileName.trim();
            // í™•ì¥ìê°€ ì—†ìœ¼ë©´ .wavë¡œ ìë™ ì²˜ë¦¬
            if(!cleanAudioName.toLowerCase().endsWith('.wav') && !cleanAudioName.toLowerCase().endsWith('.mp3')) {
                cleanAudioName += '.wav';
            }
            
            currentAudio = new Audio(`${audioFolder}/${encodeURIComponent(cleanAudioName)}`);
            currentAudio.onerror = () => {
                feedbackArea.innerHTML = "ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                feedbackArea.className = 'incorrect';
                allAudioButtons.forEach(btn => btn.disabled = true);
            };

            const prevProblemEl = document.querySelector('.problem-list-item.current');
            if (prevProblemEl) prevProblemEl.classList.remove('current');
            const currentProblemEl = document.getElementById(`problem-item-${currentQuestionIndex}`);
            if (currentProblemEl) {
                currentProblemEl.classList.add('current');
                if (currentQuestion.isCompleted) {
                    currentProblemEl.classList.remove('blurred');
                    currentProblemEl.classList.add('completed');
                }
            }

            answerInput.value = "";
            feedbackArea.innerHTML = "";
            feedbackArea.className = "";
            
            // íŒíŠ¸ ì´ˆê¸°í™”
            isSoundHintVisible = false; 
            isSoundHintStage2Visible = false; // 2ë‹¨ê³„ ì´ˆê¸°í™”
            isRuleHintVisible = false; 
            isAnswerHintVisible = false;
            
            updateHintDisplays();
            allHintButtons.forEach(btn => {
                btn.classList.remove('bg-amber-100', 'border-amber-400');
            });

            ruleHintData = {}; isAllRulesVisible = false;
            nextBtn.style.display = 'none';

            if (currentQuestion.isCompleted) setUIStateCompleted();
            else setUIStateActive();
        }

        function setUIStateActive() {
            answerInput.disabled = false;
            submitBtn.disabled = false;
            submitBtn.textContent = "ì œì¶œí•˜ê¸°";
            [...allAudioButtons, ...allHintButtons].forEach(el => el.disabled = false);

            const isFirst = (currentQuestionIndex === 0);
            const isLast = (currentQuestionIndex === quizSet.length - 1);
            prevQBtn.disabled = isFirst;
            prevQBtnBottom.disabled = isFirst;
            nextQBtn.disabled = isLast;
            nextQBtnBottom.disabled = isLast;
        }

        function setUIStateCompleted() {
            answerInput.disabled = true;
            submitBtn.disabled = true;
            submitBtn.textContent = "í•™ìŠµ ì™„ë£Œ";
            [...allAudioButtons, ...allHintButtons].forEach(el => el.disabled = false);

            const isFirst = (currentQuestionIndex === 0);
            const isLast = (currentQuestionIndex === quizSet.length - 1);
            prevQBtn.disabled = isFirst;
            prevQBtnBottom.disabled = isFirst;
            nextQBtn.disabled = isLast;
            nextQBtnBottom.disabled = isLast;
        }

        // --- 5. ì˜¤ë””ì˜¤ ì¬ìƒ ë¡œì§ ---
        function playAudio(times, interval, rate) {
            stopAudioLoop();
            if (!currentAudio || !currentAudio.src) return;
            let count = 0;
            function play() {
                if (count >= times) { audioPlayLoopId = null; return; }
                count++;
                currentAudio.playbackRate = rate;
                currentAudio.currentTime = 0;
                currentAudio.onended = () => {
                    if (count < times) audioPlayLoopId = setTimeout(play, interval);
                    else audioPlayLoopId = null;
                };
                currentAudio.play().catch(e => console.error("ì¬ìƒ ì˜¤ë¥˜", e));
            }
            play();
        }

        function playAllAudio() {
            stopAudioLoop();
            allAudioPlayer.isPlaying = true;
            allAudioPlayer.index = 0;
            [play1Btn, play3Btn, play5Btn, playSlowBtn, submitBtn, prevQBtnBottom, nextQBtnBottom].forEach(btn => btn.disabled = true);
            playAllBtn.textContent = "â–  ì¤‘ì§€";
            playAllBtn.classList.replace('bg-rose-100', 'bg-rose-500');
            playAllBtn.classList.replace('text-rose-700', 'text-white');
            playNextInAll();
        }

        function playNextInAll() {
            if (allAudioPlayer.index >= quizSet.length || !allAudioPlayer.isPlaying) {
                stopPlayAllAudio();
                return;
            }

            const item = quizSet[allAudioPlayer.index];
            const type = item._quizType;
            const audioKey = (type === 'sentence') ? "Audio File Name (Sentence)" : "Audio File Name (Word)";
            const audioFileName = item[audioKey];

            if (!audioFileName) {
                allAudioPlayer.index++;
                playNextInAll();
                return;
            }

            const currentProblemEl = document.querySelector('.problem-list-item.current');
            if (currentProblemEl) currentProblemEl.classList.remove('current');
            document.getElementById(`problem-item-${allAudioPlayer.index}`).classList.add('current');
            progressIndicator.textContent = `ì „ì²´ ë“£ê¸° (${allAudioPlayer.index + 1} / ${quizSet.length})`;

            const audioFolder = (type === 'word') ? "audio1" : "audio2";
            let cleanName = audioFileName.trim();
            if(!cleanName.toLowerCase().endsWith('.wav') && !cleanName.toLowerCase().endsWith('.mp3')) {
                cleanName += '.wav';
            }

            allAudioPlayer.audio = new Audio(`${audioFolder}/${encodeURIComponent(cleanName)}`);
            allAudioPlayer.audio.onended = () => {
                allAudioPlayer.index++;
                allAudioPlayer.timeoutId = setTimeout(playNextInAll, 1000);
            };
            allAudioPlayer.audio.onerror = () => {
                allAudioPlayer.index++;
                playNextInAll();
            };
            allAudioPlayer.audio.play();
        }

        function stopAudioLoop() {
            if (audioPlayLoopId) { clearTimeout(audioPlayLoopId); audioPlayLoopId = null; }
            if (currentAudio) { currentAudio.pause(); currentAudio.onended = null; }
            stopPlayAllAudio();
        }

        function stopPlayAllAudio() {
            if (!allAudioPlayer.isPlaying) return;
            allAudioPlayer.isPlaying = false;
            if (allAudioPlayer.timeoutId) clearTimeout(allAudioPlayer.timeoutId);
            if (allAudioPlayer.audio) allAudioPlayer.audio.pause();
            allAudioPlayer.timeoutId = null;
            allAudioPlayer.audio = null;
            playAllBtn.textContent = "ì „ì²´";
            playAllBtn.classList.replace('bg-rose-500', 'bg-rose-100');
            playAllBtn.classList.replace('text-white', 'text-rose-700');
            loadQuestion(currentQuestionIndex);
        }

        // --- 6. íŒíŠ¸ ë° ì •ë‹µ ë¡œì§ ---
        
        // 2ë‹¨ê³„ íŒíŠ¸(ë¹¨ê°„ìƒ‰ í‘œì‹œ) í† ê¸€ í•¨ìˆ˜
        function toggleStage2Hint() {
            isSoundHintStage2Visible = !isSoundHintStage2Visible;
            updateHintDisplays();
        }

        function updateHintDisplays() {
            if (!currentQuestion) return;
            
            const correctAnswer = currentQuestion[keyForAnswer];
            const soundHint = currentQuestion[keyForSoundHint];
            const normalizedCorrect = normalizeText(correctAnswer);
            const normalizedSound = normalizeText(soundHint);

            // --- 1ë‹¨ê³„ (ê¸°ë³¸) ì†Œë¦¬ HTML ---
            // í…ìŠ¤íŠ¸ + ë²„íŠ¼(ON)
            let soundHtmlBasic = `<div class="hint-content-box">
                                    <div class="flex items-center justify-center gap-2">
                                        <span>${normalizedSound}</span>
                                        <button class="stage2-trigger-btn" onclick="toggleStage2Hint()" title="ì¶”ê°€ íŒíŠ¸ ë³´ê¸°">ğŸ‘†</button>
                                    </div>
                                  </div>`;

            // --- 2ë‹¨ê³„ (Diff) ì†Œë¦¬ HTML ---
            const diff = generateDiffHtml(normalizedCorrect, normalizedSound);
            
            // ì •ë‹µ ë°•ìŠ¤ìš© (ë²„íŠ¼ ì—†ìŒ, ê°€ë¡œ ë°°ì¹˜)
            let answerHtmlDiff = `<div class="hint-content-box"><div>${diff.html1}</div></div>`;
            
            // ì†Œë¦¬ ë°•ìŠ¤ìš© (2ì°¨ íŒíŠ¸: Diff í…ìŠ¤íŠ¸ + ë²„íŠ¼(OFF), ê°€ë¡œ ë°°ì¹˜)
            let soundHtmlDiff = `<div class="hint-content-box">
                                    <div class="flex items-center justify-center gap-2">
                                        <div>${diff.html2}</div>
                                        <button class="stage2-trigger-btn" onclick="toggleStage2Hint()" title="ê¸°ë³¸ íŒíŠ¸ë¡œ ë³´ê¸°">ğŸ‘†</button>
                                    </div>
                                 </div>`;
            
            // í˜„ì¬ ìƒíƒœì— ë”°ë¥¸ ì†Œë¦¬ íŒíŠ¸ ì„ íƒ
            let currentSoundHtml = isSoundHintStage2Visible ? soundHtmlDiff : soundHtmlBasic;

            // 1. ì •ë‹µ ë³´ê¸°ê°€ í™œì„±í™”ëœ ê²½ìš°
            if (isAnswerHintVisible) {
                // ì •ë‹µ ë°•ìŠ¤ í‘œì‹œ
                hintDisplayAnswer.innerHTML = `<div class="hint-label-box text-amber-800">ğŸ‘€ ì •ë‹µ</div>${answerHtmlDiff}`;
                hintDisplayAnswer.style.display = 'grid';

                // ì†Œë¦¬ íŒíŠ¸ ë°•ìŠ¤ í‘œì‹œ (í˜„ì¬ ë‹¨ê³„ì— ë§ì¶° í‘œì‹œ)
                hintDisplaySound.innerHTML = `<div class="hint-label-box text-blue-700 bg-blue-50 border-r border-blue-200">ğŸ’¡ ì†Œë¦¬</div>${currentSoundHtml}`;
                hintDisplaySound.style.display = 'grid';
            } 
            // 2. ì •ë‹µ ë³´ê¸°ëŠ” êº¼ì ¸ìˆì§€ë§Œ, ì†Œë¦¬ íŒíŠ¸ê°€ ì¼œì§„ ê²½ìš°
            else if (isSoundHintVisible) {
                // ì •ë‹µ ë°•ìŠ¤ ìˆ¨ê¹€
                hintDisplayAnswer.style.display = 'none';

                // ì†Œë¦¬ íŒíŠ¸ ë°•ìŠ¤ í‘œì‹œ (í˜„ì¬ ë‹¨ê³„ì— ë§ì¶° í‘œì‹œ)
                hintDisplaySound.innerHTML = `<div class="hint-label-box text-blue-700 bg-blue-50 border-r border-blue-200">ğŸ’¡ ì†Œë¦¬</div>${currentSoundHtml}`;
                hintDisplaySound.style.display = 'grid';
            } 
            // 3. ë‘˜ ë‹¤ êº¼ì§„ ê²½ìš°
            else {
                hintDisplayAnswer.style.display = 'none';
                hintDisplaySound.style.display = 'none';
            }

            // ê·œì¹™ íŒíŠ¸ í‘œì‹œ (ë…ë¦½ì )
            if (isRuleHintVisible) {
                showRuleHintOptions();
                hintDisplayRule.style.display = 'block';
            } else {
                hintDisplayRule.style.display = 'none';
            }
        }

        function generateDiffHtml(str1, str2) {
            let html1 = '', html2 = '';
            const len = Math.max(str1.length, str2.length);
            for (let i = 0; i < len; i++) {
                const c1 = str1[i] || '', c2 = str2[i] || '';
                if (c1 === c2) {
                    html1 += `<span class="diff-char-black">${c1}</span>`;
                    html2 += `<span class="diff-char-black">${c2}</span>`;
                } else {
                    html1 += `<span class="diff-char-red">${c1}</span>`;
                    html2 += `<span class="diff-char-red">${c2}</span>`;
                }
            }
            return { html1, html2 };
        }

        function showRuleHintOptions() {
            let ruleHtml = '<strong class="text-amber-800 block mb-2">ğŸ§© ì ìš© ê·œì¹™</strong><div id="rule-hint-buttons" class="flex flex-wrap gap-2">';
            let hasRules = false;

            if (Object.keys(ruleHintData).length === 0 && currentQuestion) {
                for (let i = 0; i < 5; i++) {
                    const titleKey = keyForRules[i];
                    const hintKey = keyForHints[i];
                    if (currentQuestion[titleKey]) {
                        ruleHintData[currentQuestion[titleKey]] = {
                            title: currentQuestion[titleKey],
                            hint: (currentQuestion[hintKey] || "íŒíŠ¸ ì—†ìŒ").replace(/'/g, "\\'"),
                            visible: false
                        };
                    }
                }
            }
            
            const titles = Object.keys(ruleHintData);
            if (titles.length === 0) {
                hintDisplayRule.innerHTML = "<p class='text-gray-500'>ë“±ë¡ëœ ê·œì¹™ íŒíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                return;
            }

            ruleHtml += `<button class="rule-hint-btn show-all px-3 py-1 border rounded bg-white hover:bg-gray-100 ${isAllRulesVisible?'active':''}" onclick="toggleAllRules(this)">ì „ì²´</button>`;
            titles.forEach((t, idx) => {
                const d = ruleHintData[t];
                const match = t.match(/^(\d+)ë²ˆ/);
                const btnText = match ? `ê·œì¹™ ${match[1]}` : `ê·œì¹™ ${idx+1}`;
                ruleHtml += `<button class="rule-hint-btn px-3 py-1 border rounded bg-white hover:bg-gray-100 ${d.visible?'active':''}" onclick="toggleRuleHint('${t}', this)">${btnText}</button>`;
            });
            ruleHtml += '</div><div id="rule-hint-text-area" class="mt-4 p-2 bg-white rounded border border-gray-200"></div>';
            hintDisplayRule.innerHTML = ruleHtml;
            renderRuleHintText();
        }

        function toggleRuleHint(title, btn) {
            ruleHintData[title].visible = !ruleHintData[title].visible;
            btn.classList.toggle('active', ruleHintData[title].visible);
            renderRuleHintText();
        }
        function toggleAllRules(btn) {
            isAllRulesVisible = !isAllRulesVisible;
            for(let t in ruleHintData) ruleHintData[t].visible = isAllRulesVisible;
            showRuleHintOptions();
        }
        function renderRuleHintText() {
            const area = document.getElementById('rule-hint-text-area');
            if(!area) return;
            area.innerHTML = '';
            for(let t in ruleHintData) {
                const d = ruleHintData[t];
                if(d.visible) {
                    const match = d.title.match(/^(\d+)ë²ˆ/);
                    let link = '';
                    if(match && ruleFileMap[match[1]]) {
                        link = `<a href="rules/${ruleFileMap[match[1]]}" class="ml-1 text-blue-500 hover:text-blue-700" target="_blank">${bookIconEmoji}</a>`;
                    }
                    area.innerHTML += `<div class="mb-2"><strong class="text-blue-600">${d.title}</strong>${link}<br><span class="text-gray-700">${d.hint.replace(/\\'/g,"'")}</span></div>`;
                }
            }
            if(area.innerHTML === '') area.innerHTML = '<span class="text-gray-400 text-sm">ë³´ê³  ì‹¶ì€ ê·œì¹™ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</span>';
        }

        function checkAnswer() {
            const userAns = normalizeText(answerInput.value.trim());
            const correctAns = normalizeText(currentQuestion[keyForAnswer]);
            if (userAns === correctAns) {
                currentQuestion.isCompleted = true;
                setUIStateCompleted();
                const allDone = quizSet.every(q => q.isCompleted);
                if (allDone) showQuizCompleteModal();
                else showCorrectModal();
            } else {
                feedbackArea.innerHTML = "ğŸ˜¥ ì•„ë‹™ë‹ˆë‹¤. ë‹¤ì‹œ ìƒê°í•´ë³´ì„¸ìš”.";
                feedbackArea.className = 'incorrect';
                answerInput.focus();
                // ì˜¤ë‹µ ì• ë‹ˆë©”ì´ì…˜
                answerInput.classList.add('ring-red-400', 'border-red-400', 'shake');
                setTimeout(() => answerInput.classList.remove('ring-red-400', 'border-red-400', 'shake'), 500);
            }
        }

        function showCorrectModal() {
            mainContent.classList.add('grayscale');
            modalOverlay.style.display = 'flex';
            modalNextBtn.style.display = (currentQuestionIndex === quizSet.length - 1) ? 'none' : 'block';
        }
        function hideCorrectModal() {
            mainContent.classList.remove('grayscale');
            modalOverlay.style.display = 'none';
        }
        function showQuizCompleteModal() {
            mainContent.classList.add('grayscale');
            quizCompleteModalOverlay.style.display = 'flex';
        }
        function hideQuizCompleteModal() {
            mainContent.classList.remove('grayscale');
            quizCompleteModalOverlay.style.display = 'none';
        }
        function handleNoQuestions() {
            problemListContainer.innerHTML = `<div class="text-center py-8 w-full"><h3 class="text-xl font-bold text-gray-600 mb-2">ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤</h3><p class="text-gray-500 mb-4">ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p><a href="index.html" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">ëŒì•„ê°€ê¸°</a></div>`;
        }
        function disableAllControls(disable) {
            [answerInput, submitBtn, ...allAudioButtons, ...allHintButtons].forEach(el => el.disabled = disable);
        }
        function loadNextQuestion(auto) {
            if (currentQuestionIndex < quizSet.length - 1) loadQuestion(currentQuestionIndex + 1);
        }
        function loadPreviousQuestion() {
            if (currentQuestionIndex > 0) loadQuestion(currentQuestionIndex - 1);
        }
    </script>
</body>
</html>