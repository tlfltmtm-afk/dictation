<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úçÔ∏è Í±∞Íæ∏Î°ú Î∞õÏïÑÏì∞Í∏∞</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap');

        :root {
            --font-main: 'Gowun Dodum', sans-serif;
            --color-bg: #f7f3e9;
            --color-surface: #fff;
            --color-primary: #5cb85c;
            --color-secondary: #0275d8;
            --color-warning: #f0ad4e;
            --color-info: #5bc0de;
            --color-danger: #d9534f;
            --color-text: #333;
            --color-text-light: #888;
            --color-disabled: #ccc;
            --color-hint-active: #6c757d;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
        }

        main {
            background-color: var(--color-surface);
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            padding: 30px 40px;
            box-sizing: border-box;
            text-align: center;
            position: relative;
            transition: filter 0.3s ease-in-out;
        }

        main.grayscale {
            filter: grayscale(100%);
        }

        #info-link {
            position: absolute;
            top: 30px;
            right: 40px;
            opacity: 0.8;
            transition: opacity 0.2s;
            font-size: 28px;
            text-decoration: none;
            color: var(--color-warning);
        }

        #info-link:hover { opacity: 1; }

        h1 {
            color: var(--color-primary);
            margin-top: 0;
            margin-bottom: 10px;
        }

        #q-nav-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        #progress-indicator {
            font-size: 1.1em;
            color: var(--color-text-light);
            font-weight: bold;
            margin: 0;
        }

        .q-nav-btn {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--color-secondary);
            cursor: pointer;
            text-decoration: none;
            padding: 0 10px;
            user-select: none;
        }

        .q-nav-btn:hover { color: var(--color-primary); }
        .q-nav-btn.disabled { color: var(--color-disabled); cursor: not-allowed; opacity: 0.5; }

        #audio-controls-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 25px;
        }

        .audio-btn {
            padding: 12px 5px;
            font-size: 1.0em;
            font-family: var(--font-main);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            transition: background-color 0.2s, opacity 0.2s;
        }

        #play-1, #play-3, #play-5 { background-color: var(--color-secondary); }
        #play-1:hover:not(:disabled), #play-3:hover:not(:disabled), #play-5:hover:not(:disabled) { background-color: #025aa5; }
        
        #play-slow { background-color: var(--color-info); }
        #play-slow:hover:not(:disabled) { background-color: #4694ab; }
        
        #play-all { background-color: var(--color-danger); }
        #play-all:hover:not(:disabled) { background-color: #b0413e; }

        #problem-list-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            min-height: 40px;
            align-items: center;
        }

        .problem-list-item {
            padding: 6px 12px;
            font-size: 1.0em;
            font-family: var(--font-main);
            border-radius: 6px;
            background-color: #e0e0e0;
            border: 1px solid #c0c0c0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .problem-list-item.blurred {
            filter: blur(3px);
            color: transparent;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            user-select: none;
        }

        .problem-list-item.completed {
            filter: none;
            background-color: var(--color-surface);
            color: var(--color-text);
            border-color: #ccc;
            text-shadow: none;
        }

        .problem-list-item.current {
            background-color: var(--color-warning);
            border-color: var(--color-warning);
            font-weight: bold;
            transform: scale(1.05);
            text-shadow: 0 0 6px rgba(255, 255, 255, 0.7);
        }

        #answer-input {
            width: 100%;
            padding: 15px;
            font-size: 1.3em;
            font-family: var(--font-main);
            border: 2px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            text-align: center;
            margin-bottom: 15px;
        }

        #submission-area {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .submit-area-btn {
            padding: 15px;
            font-size: 1.3em;
            font-weight: bold;
            font-family: var(--font-main);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            transition: background-color 0.2s, opacity 0.2s;
            flex: 1;
        }

        #submit-btn { background-color: var(--color-primary); flex: 2; }
        #submit-btn:disabled { color: white; }
        
        .q-nav-btn-bottom {
            background-color: #888;
            font-size: 1.5em;
            padding: 10px;
            line-height: 1.3;
        }
        .q-nav-btn-bottom:hover:not(:disabled) { background-color: #666; }

        #feedback-area {
            min-height: 24px;
            padding: 5px 0;
            margin-top: 10px;
            font-size: 1.2em;
            font-weight: bold;
            line-height: 1.6;
            text-align: center;
        }
        #feedback-area.correct { color: var(--color-primary); }
        #feedback-area.incorrect { color: var(--color-danger); }

        hr.divider {
            border: 0;
            height: 1px;
            background-color: #eee;
            margin-top: 10px;
            margin-bottom: 15px;
        }

        #hint-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .hint-btn {
            padding: 12px 10px;
            font-size: 1.1em;
            font-family: var(--font-main);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--color-warning);
            color: white;
            transition: background-color 0.2s, opacity 0.2s;
        }

        .hint-btn:hover:not(:disabled) { background-color: #e89e3a; }
        .hint-btn.active { background-color: var(--color-hint-active); }
        .hint-btn.active:hover:not(:disabled) { background-color: #5a6268; }

        #result-area {
            min-height: 50px;
            margin-bottom: 25px;
            font-size: 1.1em;
            line-height: 1.6;
            text-align: left;
        }

        .hint-display {
            display: none;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #ddd;
        }

        .hint-display.two-column {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px;
            align-items: center;
            padding: 10px 15px;
        }

        .hint-label-box {
            background-color: #f4f4f4;
            padding: 15px 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
        }

        .hint-content-box {
            text-align: center;
            font-size: 1.15em;
            font-weight: 500;
            word-break: keep-all;
        }

        .diff-char-red { color: var(--color-danger); font-weight: bold; }
        .diff-char-black { color: var(--color-text); }

        #hint-display-answer {
            background-color: #fdfaf2;
            border-color: var(--color-warning);
            border-width: 2px;
        }
        #hint-display-answer .hint-label-box { background-color: #fff; border: 1px solid #f0ad4e; }

        #hint-display-sound {
            background-color: #f7faff;
            border-color: var(--color-secondary);
            border-width: 2px;
        }
        #hint-display-sound .hint-label-box { background-color: #fff; border: 1px solid #0275d8; }

        #hint-display-rule { background-color: #f9f9f9; border-color: #eee; }

        .rule-link-icon {
            display: inline-block;
            text-decoration: none;
            margin-left: 5px;
            vertical-align: middle;
            opacity: 0.8;
            transition: opacity 0.2s;
            color: var(--color-secondary);
            font-size: 1.1em;
        }
        .rule-link-icon:hover { opacity: 1; color: var(--color-primary); }

        #rule-hint-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
        }

        .rule-hint-btn {
            padding: 8px 12px;
            font-size: 1.0em;
            font-family: var(--font-main);
            border: 1px solid var(--color-warning);
            border-radius: 8px;
            cursor: pointer;
            background-color: #fff;
            color: var(--color-text);
            flex-grow: 1;
            flex-basis: 0;
            min-width: 60px;
            transition: background-color 0.2s, color 0.2s;
        }

        .rule-hint-btn.show-all {
            background-color: var(--color-info);
            color: white;
            border-color: var(--color-info);
            font-weight: bold;
        }

        .rule-hint-btn.active {
            background-color: var(--color-hint-active);
            color: white;
            border-color: #5a6268;
        }

        #navigation-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #next-btn {
            padding: 12px 25px;
            font-size: 1.2em;
            font-family: var(--font-main);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: #333;
            color: white;
            transition: background-color 0.2s;
        }
        #next-btn:hover { background-color: #555; }

        #back-link {
            font-size: 1.1em;
            color: var(--color-secondary);
            text-decoration: none;
        }
        #back-link:hover { text-decoration: underline; }

        [disabled] {
            background-color: var(--color-disabled) !important;
            opacity: 0.7;
            cursor: not-allowed !important;
        }

        /* Î™®Îã¨ Ïä§ÌÉÄÏùº */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; justify-content: center; align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white; border-radius: 15px; padding: 30px 40px;
            text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%; max-width: 400px;
        }

        .modal-text {
            font-size: 1.8em; font-weight: bold; color: var(--color-text); margin-bottom: 30px;
        }

        .modal-buttons { display: flex; gap: 15px; }

        .modal-btn {
            flex: 1; padding: 12px; font-size: 1.2em; font-family: var(--font-main);
            font-weight: bold; border: none; border-radius: 8px; cursor: pointer;
            transition: background-color 0.2s;
        }

        #modal-circle {
            width: 150px; height: 150px; border-radius: 50%; margin: 0 auto 25px auto;
            border: 15px solid var(--color-danger); background-color: transparent; box-sizing: border-box;
        }

        #modal-close-btn { background-color: #aaa; color: white; }
        #modal-close-btn:hover { background-color: #888; }
        #modal-next-btn { background-color: var(--color-primary); color: white; }
        #modal-next-btn:hover { background-color: #4a9e4a; }

        #quiz-complete-close-btn { background-color: #aaa; color: white; }
        #quiz-complete-close-btn:hover { background-color: #888; }
        #quiz-complete-home-btn { background-color: var(--color-primary); color: white; }
        #quiz-complete-home-btn:hover { background-color: #4a9e4a; }
    </style>
</head>

<body>
    <main id="main-content">
        <a href="rules.html" id="info-link" target="_blank" title="Í∑úÏπô ÏÑ§Î™Ö Î≥¥Í∏∞">üìö</a>

        <h1>‚úçÔ∏è Í±∞Íæ∏Î°ú Î∞õÏïÑÏì∞Í∏∞</h1>

        <div id="audio-controls-container">
            <button id="play-slow" class="audio-btn">üîä ÎäêÎ¶¨Í≤å</button>
            <button id="play-1" class="audio-btn">üîä 1Ìöå</button>
            <button id="play-3" class="audio-btn">üîä 3Ìöå</button>
            <button id="play-5" class="audio-btn">üîä 5Ìöå</button>
            <button id="play-all" class="audio-btn">üîä Ï†ÑÏ≤¥</button>
        </div>

        <div id="problem-list-container"></div>

        <div id="q-nav-container">
            <a id="prev-q-btn" class="q-nav-btn" title="Ïù¥Ï†Ñ Î¨∏Ï†ú">‚óÄ</a>
            <div id="progress-indicator">Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            <a id="next-q-btn" class="q-nav-btn" title="Îã§Ïùå Î¨∏Ï†ú">‚ñ∂</a>
        </div>

        <input type="text" id="answer-input" placeholder="Ï†ïÎãµÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">

        <div id="submission-area">
            <button id="prev-q-btn-bottom" class="submit-area-btn q-nav-btn-bottom" title="Ïù¥Ï†Ñ Î¨∏Ï†ú">‚óÄ</button>
            <button id="submit-btn" class="submit-area-btn">Ï†úÏ∂úÌïòÍ∏∞</button>
            <button id="next-q-btn-bottom" class="submit-area-btn q-nav-btn-bottom" title="Îã§Ïùå Î¨∏Ï†ú (Í±¥ÎÑàÎõ∞Í∏∞)">‚ñ∂</button>
        </div>

        <div id="feedback-area"></div>

        <hr class="divider">

        <div id="hint-container">
            <button id="hint-sound" class="hint-btn">üí° ÏÜåÎ¶¨ ÌûåÌä∏</button>
            <button id="hint-rule" class="hint-btn">üß© Í∑úÏπô ÌûåÌä∏</button>
            <button id="hint-answer" class="hint-btn">üëÄ Ï†ïÎãµ Î≥¥Í∏∞</button>
        </div>

        <div id="result-area">
            <div id="hint-display-answer" class="hint-display two-column"></div>
            <div id="hint-display-sound" class="hint-display two-column"></div>
            <div id="hint-display-rule" class="hint-display"></div>
        </div>

        <div id="navigation-area">
            <a href="index.html" id="back-link">‚Üê Î≤îÏúÑ ÏÑ†ÌÉùÏúºÎ°ú</a>
            <button id="next-btn" style="display: none;">Îã§Ïùå Î¨∏Ï†ú ‚ûî</button>
        </div>
    </main>

    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content">
            <div id="modal-circle"></div>
            <div id="modal-text" class="modal-text">üéâ Ï†ïÎãµÏûÖÎãàÎã§!</div>
            <div id="modal-buttons" class="modal-buttons">
                <button id="modal-close-btn" class="modal-btn">Îã´Í∏∞</button>
                <button id="modal-next-btn" class="modal-btn">Îã§Ïùå Î¨∏Ï†ú ‚ûî</button>
            </div>
        </div>
    </div>

    <div id="quiz-complete-modal-overlay" class="modal-overlay">
        <div id="quiz-complete-modal-content" class="modal-content">
            <div id="quiz-complete-modal-text" class="modal-text">‚ú® Î™®Îì† ÌÄ¥Ï¶àÎ•º ÏôÑÎ£åÌñàÏäµÎãàÎã§!</div>
            <p style="font-size: 1.1em; margin-top: -15px; margin-bottom: 30px;">Ï∂ïÌïòÌï©ÎãàÎã§! <br>Î≤îÏúÑ ÏÑ†ÌÉù ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞Ä<br>Îã§Î•∏ ÌÄ¥Ï¶àÏóê ÎèÑÏ†ÑÌï¥Î≥¥ÏÑ∏Ïöî.</p>
            <div id="quiz-complete-modal-buttons" class="modal-buttons">
                <button id="quiz-complete-close-btn" class="modal-btn">Îã´Í∏∞</button>
                <button id="quiz-complete-home-btn" class="modal-btn">Ìôà(Ïù∏Îç±Ïä§)ÏúºÎ°ú</button>
            </div>
        </div>
    </div>

    <script src="database.js"></script>

    <script>
        /* global quizData */

        // --- 1. Ï†ÑÏó≠ Î≥ÄÏàò ---
        let quizSet = [];
        let currentQuestionIndex = 0;
        let currentQuestion = null;
        let currentAudio = null;
        let audioPlayLoopId = null;

        let allAudioPlayer = {
            index: 0,
            timeoutId: null,
            audio: null,
            isPlaying: false
        };

        // ÌûåÌä∏/ÏÑ§Ï†ï ÌÇ§Í∞í
        let keyForAudio, keyForAnswer, keyForSoundHint, keyForRules, keyForHints;
        let placeholderText;

        // ÌûåÌä∏ ÏÉÅÌÉú
        let isSoundHintVisible = false;
        let isRuleHintVisible = false;
        let isAnswerHintVisible = false;
        let ruleHintData = {};
        let isAllRulesVisible = false;

        const ruleFileMap = {
            1: 'rule01_yeonum.html', 2: 'rule02_eumjeol_kkwessori.html', 3: 'rule03_jaeumgun_dansunhwa.html',
            4: 'rule04_doensori_doegi.html', 5: 'rule05_jaeum_donghwa.html', 6: 'rule06_gugaeumhwa.html',
            7: 'rule07_jaeum_chukyak.html', 8: 'rule08_h_tallak.html', 9: 'rule09_moeum_chukyak.html',
            10: 'rule10_n_cheomga.html', 11: 'rule11_dueum_beopchik.html', 12: 'rule12_ttyeossuegi.html',
            13: 'rule13_ssangdungyi_moeum.html', 14: 'rule14_sori_pyogi.html'
        };

        // DOM Elements
        const mainContent = document.getElementById('main-content');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalNextBtn = document.getElementById('modal-next-btn');
        const quizCompleteModalOverlay = document.getElementById('quiz-complete-modal-overlay');
        const quizCompleteCloseBtn = document.getElementById('quiz-complete-close-btn');
        const quizCompleteHomeBtn = document.getElementById('quiz-complete-home-btn');
        const problemListContainer = document.getElementById('problem-list-container');
        const progressIndicator = document.getElementById('progress-indicator');
        const prevQBtn = document.getElementById('prev-q-btn');
        const nextQBtn = document.getElementById('next-q-btn');
        const answerInput = document.getElementById('answer-input');
        const submitBtn = document.getElementById('submit-btn');
        const prevQBtnBottom = document.getElementById('prev-q-btn-bottom');
        const nextQBtnBottom = document.getElementById('next-q-btn-bottom');
        const feedbackArea = document.getElementById('feedback-area');
        const hintDisplayAnswer = document.getElementById('hint-display-answer');
        const hintDisplaySound = document.getElementById('hint-display-sound');
        const hintDisplayRule = document.getElementById('hint-display-rule');
        const nextBtn = document.getElementById('next-btn');
        
        // Buttons
        const playSlowBtn = document.getElementById('play-slow');
        const play1Btn = document.getElementById('play-1');
        const play3Btn = document.getElementById('play-3');
        const play5Btn = document.getElementById('play-5');
        const playAllBtn = document.getElementById('play-all');
        const hintSoundBtn = document.getElementById('hint-sound');
        const hintRuleBtn = document.getElementById('hint-rule');
        const hintAnswerBtn = document.getElementById('hint-answer');

        const allAudioButtons = [play1Btn, play3Btn, play5Btn, playSlowBtn, playAllBtn];
        const allHintButtons = [hintSoundBtn, hintRuleBtn, hintAnswerBtn];
        const bookIconEmoji = 'üìö';

        // --- 2. Ìó¨Ìçº Ìï®Ïàò ---
        function normalizeText(text) {
            if (typeof text !== 'string') return "";
            return text.replace(/[.,!?~"'"\[\]]/g, '');
        }

        function setupQuizType(quizType) {
            if (quizType === 'sentence') {
                keyForAudio = "Audio File Name (Sentence)";
                keyForAnswer = "Sentence Notation";
                keyForSoundHint = "Sentence sound notation";
                keyForRules = ["Syllable 1 Rule", "Syllable 2 rule", "Syllable 3 Rule", "Syllable 4 Rule", "Syllable 5 Rule"];
                keyForHints = ["Syllable 1 Rule", "Syllable 2 rule", "Syllable 3 Rule", "Syllable 4 Rule", "Syllable 5 Rule"];
                placeholderText = "Î¨∏Ïû•ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.(ÎùÑÏñ¥Ïì∞Í∏∞ Ìè¨Ìï®)";
            } else {
                keyForAudio = "Audio File Name (Word)";
                keyForAnswer = "Word Notation";
                keyForSoundHint = "Word phonetic notation";
                keyForRules = ["Syllable 1 Rule", "Syllable 2 rule", "Syllable 3 Rule", "Syllable 4 Rule", "Syllable 5 Rule"];
                keyForHints = ["Syllable 1 Rule", "Syllable 2 rule", "Syllable 3 Rule", "Syllable 4 Rule", "Syllable 5 Rule"];
                placeholderText = "ÎÇ±ÎßêÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî";
            }
            if (answerInput) answerInput.placeholder = placeholderText;
        }

        function filterQuizSet(grade, unit, rule, quizType) {
            const tempKeyForAnswer = (quizType === 'sentence') ? "Sentence Notation" : "Word Notation";

            quizSet = quizData.filter(item => {
                const gradeMatch = (grade === 'all' || item["Year/Semester"] === grade);
                const unitMatch = (unit === 'all' || item["Chapter"] === unit);
                let ruleMatch = (rule === 'all');
                if (rule !== 'all') {
                    const ruleKeys = ["Syllable 1 Rule", "Syllable 2 rule", "Syllable 3 Rule", "Syllable 4 Rule", "Syllable 5 Rule"];
                    for (const rK of ruleKeys) {
                        if (item[rK] === rule) {
                            ruleMatch = true; break;
                        }
                    }
                }
                const typeMatch = (quizType === 'word' || (item[tempKeyForAnswer] && item[tempKeyForAnswer].trim() !== ""));
                return gradeMatch && unitMatch && ruleMatch && typeMatch;
            });
        }

        function shuffleQuizSet() {
            for (let i = quizSet.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [quizSet[i], quizSet[j]] = [quizSet[j], quizSet[i]];
            }
        }

        // --- 3. Ï¥àÍ∏∞Ìôî (Í∞úÏàò Ï†úÌïú Ï†ÅÏö©) ---
        window.onload = () => {
            try {
                if (typeof quizData === 'undefined') {
                    throw new Error("database.jsÎ•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÍ±∞ÎÇò quizData Î≥ÄÏàòÍ∞Ä ÏóÜÏäµÎãàÎã§.");
                }

                const params = new URLSearchParams(window.location.search);
                const mode = params.get('mode');

                if (mode === 'custom') {
                    // [Ïª§Ïä§ÌÖÄ Î™®Îìú]
                    const customData = sessionStorage.getItem('customQuizData');
                    if (!customData) {
                        alert("ÏÑ†ÌÉùÎêú Î¨∏Ï†úÍ∞Ä ÏóÜÏäµÎãàÎã§. ÌôàÏúºÎ°ú ÎèåÏïÑÍ∞ëÎãàÎã§.");
                        window.location.href = 'index.html';
                        return;
                    }
                    const selectedList = JSON.parse(customData);
                    quizSet = selectedList.map(item => {
                        const dataItem = quizData[item.index];
                        const newItem = Object.assign({}, dataItem);
                        newItem._quizType = item.type;
                        newItem.isCompleted = false;
                        return newItem;
                    });
                } else {
                    // [ÏùºÎ∞ò Î™®Îìú]
                    const grade = params.get('grade');
                    const unit = params.get('unit');
                    const rule = params.get('rule');
                    const quizType = params.get('type') || 'word';
                    
                    // [Í∞úÏàò Ï†úÌïú ÌïµÏã¨ Î°úÏßÅ]
                    const pCount = parseInt(params.get('count')) || 10;

                    filterQuizSet(grade, unit, rule, quizType);
                    
                    quizSet.forEach(item => {
                        item._quizType = quizType;
                        item.isCompleted = false;
                    });
                    
                    shuffleQuizSet();

                    // ‚òÖ ÏÑ§Ï†ïÌïú Í∞úÏàòÎßåÌÅº ÏûêÎ•¥Í∏∞
                    if (quizSet.length > pCount) {
                        quizSet = quizSet.slice(0, pCount);
                    }
                }

                if (quizSet.length > 0) {
                    generateProblemList();
                    loadQuestion(0);
                } else {
                    handleNoQuestions();
                }

                setupEventListeners();

            } catch (error) {
                console.error("Ïò§Î•ò Î∞úÏÉù:", error);
                mainContent.innerHTML = `<h1>Ïò§Î•ò Î∞úÏÉù</h1><p>${error.message}</p>`;
            }
        };

        function generateProblemList() {
            problemListContainer.innerHTML = '';
            quizSet.forEach((item, index) => {
                const div = document.createElement('div');
                div.id = `problem-item-${index}`;
                div.className = 'problem-list-item blurred';
                
                const type = item._quizType;
                const ansKey = (type === 'sentence') ? "Sentence Notation" : "Word Notation";
                div.textContent = item[ansKey] || "Î¨∏Ï†ú";
                
                div.onclick = () => {
                    if (index !== currentQuestionIndex) loadQuestion(index);
                };
                problemListContainer.appendChild(div);
            });
        }

        function setupEventListeners() {
            play1Btn.onclick = () => playAudio(1, 0, 1.0);
            play3Btn.onclick = () => playAudio(3, 1000, 1.0);
            play5Btn.onclick = () => playAudio(5, 1000, 1.0);
            playSlowBtn.onclick = () => playAudio(1, 0, 0.75);
            playAllBtn.onclick = playAllAudio;

            prevQBtn.onclick = loadPreviousQuestion;
            nextQBtn.onclick = () => loadNextQuestion(true);
            prevQBtnBottom.onclick = loadPreviousQuestion;
            nextQBtnBottom.onclick = () => loadNextQuestion(true);

            hintSoundBtn.onclick = () => {
                isSoundHintVisible = !isSoundHintVisible;
                updateHintDisplays();
                hintSoundBtn.classList.toggle('active', isSoundHintVisible);
            };
            hintRuleBtn.onclick = () => {
                isRuleHintVisible = !isRuleHintVisible;
                updateHintDisplays();
                hintRuleBtn.classList.toggle('active', isRuleHintVisible);
            };
            hintAnswerBtn.onclick = () => {
                isAnswerHintVisible = !isAnswerHintVisible;
                updateHintDisplays();
                hintAnswerBtn.classList.toggle('active', isAnswerHintVisible);
            };

            submitBtn.onclick = checkAnswer;
            answerInput.onkeyup = (e) => {
                if (e.key === 'Enter' && !submitBtn.disabled) checkAnswer();
            };
            nextBtn.onclick = () => loadNextQuestion(false);

            modalCloseBtn.onclick = hideCorrectModal;
            modalNextBtn.onclick = () => { hideCorrectModal(); loadNextQuestion(false); };
            quizCompleteCloseBtn.onclick = hideQuizCompleteModal;
            quizCompleteHomeBtn.onclick = () => { window.location.href = 'index.html'; };
        }

        // --- 4. Î¨∏Ï†ú Î°úÎìú Î∞è UI ---
        function loadQuestion(index) {
            stopAudioLoop();
            currentQuestionIndex = index;
            currentQuestion = quizSet[index];

            setupQuizType(currentQuestion._quizType);

            progressIndicator.textContent = `Î¨∏Ï†ú ${index + 1} / ${quizSet.length}`;

            // Ïò§ÎîîÏò§ ÏÑ§Ï†ï
            const audioFileName = currentQuestion[keyForAudio];
            if (!audioFileName || audioFileName.trim() === "") {
                feedbackArea.innerHTML = "Ïò§ÎîîÏò§ ÏóÜÏùå. Í±¥ÎÑàÎúÅÎãàÎã§.";
                feedbackArea.className = 'incorrect';
                disableAllControls(false);
                setTimeout(() => loadNextQuestion(true), 1500);
                return;
            }

            const audioFolder = (currentQuestion._quizType === 'word') ? "audio1" : "audio2";
            let cleanAudioName = audioFileName.trim();
            // ÌôïÏû•ÏûêÍ∞Ä ÏóÜÏúºÎ©¥ .wavÎ°ú ÏûêÎèô Ï≤òÎ¶¨
            if(!cleanAudioName.toLowerCase().endsWith('.wav') && !cleanAudioName.toLowerCase().endsWith('.mp3')) {
                cleanAudioName += '.wav';
            }
            
            currentAudio = new Audio(`${audioFolder}/${encodeURIComponent(cleanAudioName)}`);
            currentAudio.onerror = () => {
                feedbackArea.innerHTML = "Ïò§ÎîîÏò§ ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.";
                feedbackArea.className = 'incorrect';
                allAudioButtons.forEach(btn => btn.disabled = true);
            };

            const prevProblemEl = document.querySelector('.problem-list-item.current');
            if (prevProblemEl) prevProblemEl.classList.remove('current');
            const currentProblemEl = document.getElementById(`problem-item-${currentQuestionIndex}`);
            if (currentProblemEl) {
                currentProblemEl.classList.add('current');
                if (currentQuestion.isCompleted) {
                    currentProblemEl.classList.remove('blurred');
                    currentProblemEl.classList.add('completed');
                }
            }

            answerInput.value = "";
            feedbackArea.innerHTML = "";
            feedbackArea.className = "";
            
            isSoundHintVisible = false; isRuleHintVisible = false; isAnswerHintVisible = false;
            updateHintDisplays();
            allHintButtons.forEach(btn => btn.classList.remove('active'));
            ruleHintData = {}; isAllRulesVisible = false;
            nextBtn.style.display = 'none';

            if (currentQuestion.isCompleted) setUIStateCompleted();
            else setUIStateActive();
        }

        function setUIStateActive() {
            answerInput.disabled = false;
            submitBtn.disabled = false;
            submitBtn.textContent = "Ï†úÏ∂úÌïòÍ∏∞";
            [...allAudioButtons, ...allHintButtons].forEach(el => el.disabled = false);

            const isFirst = (currentQuestionIndex === 0);
            const isLast = (currentQuestionIndex === quizSet.length - 1);
            prevQBtn.classList.toggle('disabled', isFirst);
            prevQBtnBottom.disabled = isFirst;
            nextQBtn.classList.toggle('disabled', isLast);
            nextQBtnBottom.disabled = isLast;
        }

        function setUIStateCompleted() {
            answerInput.disabled = true;
            submitBtn.disabled = true;
            submitBtn.textContent = "ÌïôÏäµ ÏôÑÎ£å";
            [...allAudioButtons, ...allHintButtons].forEach(el => el.disabled = false);

            const isFirst = (currentQuestionIndex === 0);
            const isLast = (currentQuestionIndex === quizSet.length - 1);
            prevQBtn.classList.toggle('disabled', isFirst);
            prevQBtnBottom.disabled = isFirst;
            nextQBtn.classList.toggle('disabled', isLast);
            nextQBtnBottom.disabled = isLast;
        }

        // --- 5. Ïò§ÎîîÏò§ Ïû¨ÏÉù Î°úÏßÅ ---
        function playAudio(times, interval, rate) {
            stopAudioLoop();
            if (!currentAudio || !currentAudio.src) return;
            let count = 0;
            function play() {
                if (count >= times) { audioPlayLoopId = null; return; }
                count++;
                currentAudio.playbackRate = rate;
                currentAudio.currentTime = 0;
                currentAudio.onended = () => {
                    if (count < times) audioPlayLoopId = setTimeout(play, interval);
                    else audioPlayLoopId = null;
                };
                currentAudio.play().catch(e => console.error("Ïû¨ÏÉù Ïò§Î•ò", e));
            }
            play();
        }

        function playAllAudio() {
            stopAudioLoop();
            allAudioPlayer.isPlaying = true;
            allAudioPlayer.index = 0;
            [play1Btn, play3Btn, play5Btn, playSlowBtn, submitBtn, prevQBtnBottom, nextQBtnBottom].forEach(btn => btn.disabled = true);
            playAllBtn.textContent = "‚ñ† Ï§ëÏßÄ";
            playNextInAll();
        }

        function playNextInAll() {
            if (allAudioPlayer.index >= quizSet.length || !allAudioPlayer.isPlaying) {
                stopPlayAllAudio();
                return;
            }

            const item = quizSet[allAudioPlayer.index];
            const type = item._quizType;
            const audioKey = (type === 'sentence') ? "Audio File Name (Sentence)" : "Audio File Name (Word)";
            const audioFileName = item[audioKey];

            if (!audioFileName) {
                allAudioPlayer.index++;
                playNextInAll();
                return;
            }

            const currentProblemEl = document.querySelector('.problem-list-item.current');
            if (currentProblemEl) currentProblemEl.classList.remove('current');
            document.getElementById(`problem-item-${allAudioPlayer.index}`).classList.add('current');
            progressIndicator.textContent = `Ï†ÑÏ≤¥ Îì£Í∏∞ (${allAudioPlayer.index + 1} / ${quizSet.length})`;

            const audioFolder = (type === 'word') ? "audio1" : "audio2";
            let cleanName = audioFileName.trim();
            if(!cleanName.toLowerCase().endsWith('.wav') && !cleanName.toLowerCase().endsWith('.mp3')) {
                cleanName += '.wav';
            }

            allAudioPlayer.audio = new Audio(`${audioFolder}/${encodeURIComponent(cleanName)}`);
            allAudioPlayer.audio.onended = () => {
                allAudioPlayer.index++;
                allAudioPlayer.timeoutId = setTimeout(playNextInAll, 1000);
            };
            allAudioPlayer.audio.onerror = () => {
                allAudioPlayer.index++;
                playNextInAll();
            };
            allAudioPlayer.audio.play();
        }

        function stopAudioLoop() {
            if (audioPlayLoopId) { clearTimeout(audioPlayLoopId); audioPlayLoopId = null; }
            if (currentAudio) { currentAudio.pause(); currentAudio.onended = null; }
            stopPlayAllAudio();
        }

        function stopPlayAllAudio() {
            if (!allAudioPlayer.isPlaying) return;
            allAudioPlayer.isPlaying = false;
            if (allAudioPlayer.timeoutId) clearTimeout(allAudioPlayer.timeoutId);
            if (allAudioPlayer.audio) allAudioPlayer.audio.pause();
            allAudioPlayer.timeoutId = null;
            allAudioPlayer.audio = null;
            playAllBtn.textContent = "üîä Ï†ÑÏ≤¥";
            loadQuestion(currentQuestionIndex);
        }

        // --- 6. ÌûåÌä∏ Î∞è Ï†ïÎãµ Î°úÏßÅ ---
        function updateHintDisplays() {
            if (!currentQuestion) return;
            const correctAnswer = currentQuestion[keyForAnswer];
            const soundHint = currentQuestion[keyForSoundHint];
            const normalizedCorrect = normalizeText(correctAnswer);
            const normalizedSound = normalizeText(soundHint);

            let answerHtml = `<div class="hint-content-box">${normalizedCorrect}</div>`;
            let soundHtml = `<div class="hint-content-box">${normalizedSound}</div>`;

            if (isAnswerHintVisible && isSoundHintVisible) {
                const diff = generateDiffHtml(normalizedCorrect, normalizedSound);
                answerHtml = `<div class="hint-content-box">${diff.html1}</div>`;
                soundHtml = `<div class="hint-content-box">${diff.html2}</div>`;
            }

            if (isAnswerHintVisible) {
                hintDisplayAnswer.innerHTML = `<div class="hint-label-box"><strong>üëÄ Ï†ïÎãµ</strong></div>${answerHtml}`;
                hintDisplayAnswer.style.display = 'grid';
            } else hintDisplayAnswer.style.display = 'none';

            if (isSoundHintVisible) {
                hintDisplaySound.innerHTML = `<div class="hint-label-box"><strong>üí° ÏÜåÎ¶¨ ÌûåÌä∏</strong></div>${soundHtml}`;
                hintDisplaySound.style.display = 'grid';
            } else hintDisplaySound.style.display = 'none';

            if (isRuleHintVisible) {
                showRuleHintOptions();
                hintDisplayRule.style.display = 'block';
            } else hintDisplayRule.style.display = 'none';
        }

        function generateDiffHtml(str1, str2) {
            let html1 = '', html2 = '';
            const len = Math.max(str1.length, str2.length);
            for (let i = 0; i < len; i++) {
                const c1 = str1[i] || '', c2 = str2[i] || '';
                if (c1 === c2) {
                    html1 += `<span class="diff-char-black">${c1}</span>`;
                    html2 += `<span class="diff-char-black">${c2}</span>`;
                } else {
                    html1 += `<span class="diff-char-red">${c1}</span>`;
                    html2 += `<span class="diff-char-red">${c2}</span>`;
                }
            }
            return { html1, html2 };
        }

        function showRuleHintOptions() {
            let ruleHtml = '<strong style="margin-top:0;">üß© Ï†ÅÏö© Í∑úÏπô</strong><div id="rule-hint-buttons">';
            let hasRules = false;

            if (Object.keys(ruleHintData).length === 0 && currentQuestion) {
                for (let i = 0; i < 5; i++) {
                    const titleKey = keyForRules[i];
                    const hintKey = keyForHints[i];
                    if (currentQuestion[titleKey]) {
                        ruleHintData[currentQuestion[titleKey]] = {
                            title: currentQuestion[titleKey],
                            hint: (currentQuestion[hintKey] || "ÌûåÌä∏ ÏóÜÏùå").replace(/'/g, "\\'"),
                            visible: false
                        };
                    }
                }
            }
            
            const titles = Object.keys(ruleHintData);
            if (titles.length === 0) {
                hintDisplayRule.innerHTML = "<p>Îì±Î°ùÎêú Í∑úÏπô ÌûåÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.</p>";
                return;
            }

            ruleHtml += `<button class="rule-hint-btn show-all ${isAllRulesVisible?'active':''}" onclick="toggleAllRules(this)">Ï†ÑÏ≤¥</button>`;
            titles.forEach((t, idx) => {
                const d = ruleHintData[t];
                const match = t.match(/^(\d+)Î≤à/);
                const btnText = match ? `Í∑úÏπô ${match[1]}` : `Í∑úÏπô ${idx+1}`;
                ruleHtml += `<button class="rule-hint-btn ${d.visible?'active':''}" onclick="toggleRuleHint('${t}', this)">${btnText}</button>`;
            });
            ruleHtml += '</div><div id="rule-hint-text-area" style="margin-top: 15px;"></div>';
            hintDisplayRule.innerHTML = ruleHtml;
            renderRuleHintText();
        }

        function toggleRuleHint(title, btn) {
            ruleHintData[title].visible = !ruleHintData[title].visible;
            btn.classList.toggle('active', ruleHintData[title].visible);
            renderRuleHintText();
        }
        function toggleAllRules(btn) {
            isAllRulesVisible = !isAllRulesVisible;
            for(let t in ruleHintData) ruleHintData[t].visible = isAllRulesVisible;
            showRuleHintOptions();
        }
        function renderRuleHintText() {
            const area = document.getElementById('rule-hint-text-area');
            if(!area) return;
            area.innerHTML = '';
            for(let t in ruleHintData) {
                const d = ruleHintData[t];
                if(d.visible) {
                    const match = d.title.match(/^(\d+)Î≤à/);
                    let link = '';
                    if(match && ruleFileMap[match[1]]) {
                        link = `<a href="rules/${ruleFileMap[match[1]]}" class="rule-link-icon" target="_blank">${bookIconEmoji}</a>`;
                    }
                    area.innerHTML += `<div style="margin-bottom:10px;"><strong style="color:var(--color-secondary);">${d.title}</strong>${link}<br><span>${d.hint.replace(/\\'/g,"'")}</span></div>`;
                }
            }
        }

        function checkAnswer() {
            const userAns = normalizeText(answerInput.value.trim());
            const correctAns = normalizeText(currentQuestion[keyForAnswer]);
            if (userAns === correctAns) {
                currentQuestion.isCompleted = true;
                setUIStateCompleted();
                const allDone = quizSet.every(q => q.isCompleted);
                if (allDone) showQuizCompleteModal();
                else showCorrectModal();
            } else {
                feedbackArea.innerHTML = "üò• ÏïÑÎãôÎãàÎã§. Îã§Ïãú ÏÉùÍ∞ÅÌï¥Î≥¥ÏÑ∏Ïöî.";
                feedbackArea.className = 'incorrect';
                answerInput.focus();
            }
        }

        function showCorrectModal() {
            mainContent.classList.add('grayscale');
            modalOverlay.style.display = 'flex';
            modalNextBtn.style.display = (currentQuestionIndex === quizSet.length - 1) ? 'none' : 'block';
        }
        function hideCorrectModal() {
            mainContent.classList.remove('grayscale');
            modalOverlay.style.display = 'none';
        }
        function showQuizCompleteModal() {
            mainContent.classList.add('grayscale');
            quizCompleteModalOverlay.style.display = 'flex';
        }
        function hideQuizCompleteModal() {
            mainContent.classList.remove('grayscale');
            quizCompleteModalOverlay.style.display = 'none';
        }
        function handleNoQuestions() {
            mainContent.innerHTML = `<h1>Î¨∏Ï†úÍ∞Ä ÏóÜÏäµÎãàÎã§</h1><p>Ï°∞Í±¥Ïóê Ìï¥ÎãπÌïòÎäî Î¨∏Ï†úÍ∞Ä ÏóÜÏäµÎãàÎã§.</p><a href="index.html" style="display:inline-block; margin-top:20px; padding:10px 20px; background-color:#5cb85c; color:white; text-decoration:none; border-radius:5px;">ÎèåÏïÑÍ∞ÄÍ∏∞</a>`;
        }
        function disableAllControls(disable) {
            [answerInput, submitBtn, ...allAudioButtons, ...allHintButtons].forEach(el => el.disabled = disable);
        }
        function loadNextQuestion(auto) {
            if (currentQuestionIndex < quizSet.length - 1) loadQuestion(currentQuestionIndex + 1);
        }
        function loadPreviousQuestion() {
            if (currentQuestionIndex > 0) loadQuestion(currentQuestionIndex - 1);
        }
    </script>
</body>

</html>